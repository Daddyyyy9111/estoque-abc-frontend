<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque ABC Móveis</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Chart.js CDN para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos Customizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Lighter gray for background */
            color: #1f2937; /* Darker text for better contrast */
        }
        .sidebar {
            width: 250px;
            transition: width 0.3s ease;
            position: fixed; /* Fixa a sidebar */
            height: 100%; /* Ocupa toda a altura */
            overflow-y: auto; /* Permite scroll se o conteúdo for muito grande */
            background-color: #3730a3; /* Darker indigo for sidebar */
            color: white;
            z-index: 999;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .sidebar.collapsed {
            width: 64px; /* w-16 */
        }
        .sidebar-content {
            opacity: 1;
            transition: opacity 0.3s ease;
            white-space: nowrap; /* Impede quebras de linha */
            overflow: hidden; /* Esconde o texto quando recolhido */
            flex-grow: 1; /* Permite que o texto ocupe o espaço restante */
        }
        .sidebar.collapsed .sidebar-content {
            opacity: 0;
            width: 0;
        }
        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.65rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .sidebar ul li a:hover {
            background-color: #4338ca; /* Slightly lighter indigo on hover */
            color: white;
        }
        .sidebar ul li a i {
            flex-shrink: 0; /* Impede que o ícone encolha */
        }

        /* Main Content Area */
        .main-content-area {
            margin-left: 250px; /* Adjust for sidebar width */
            padding: 2rem;
            transition: margin-left 0.3s ease;
        }
        .main-content-area.expanded {
            margin-left: 64px; /* When sidebar is collapsed */
        }

        /* Card Styles */
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.03); /* Softer, larger shadow */
            padding: 1.75rem; /* Slightly more padding */
            margin-bottom: 1.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.12), 0 6px 10px -3px rgba(0, 0, 0, 0.05);
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 1rem; /* Rounded corners for table container */
            border: 1px solid #e5e7eb; /* Subtle border */
        }
        table {
            width: 100%;
            border-collapse: separate; /* Allows border-radius on cells */
            border-spacing: 0; /* Remove default spacing */
        }
        th, td {
            padding: 1rem 1.25rem; /* More padding */
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            font-size: 0.8rem; /* Slightly larger font */
            letter-spacing: 0.05em;
            cursor: pointer;
            position: sticky; /* Sticky headers for scrollable tables */
            top: 0;
            z-index: 10;
        }
        th:first-child { border-top-left-radius: 1rem; }
        th:last-child { border-top-right-radius: 1rem; }
        tbody tr:last-child td { border-bottom: none; } /* Remove bottom border for last row */

        th.asc::after { content: " ▲"; }
        th.desc::after { content: " ▼"; }
        tbody tr:hover { background-color: #f3f4f6; }
        .no-data {
            text-align: center;
            padding: 1.5rem;
            color: #6b7280;
            font-style: italic;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; } /* Gray thumb */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6B7280;
        }
        .modal-close-button:hover {
            color: #1F2937;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Tab Buttons */
        .tab-button {
            padding: 0.85rem 1.75rem;
            border-radius: 0.65rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 0.95rem;
            flex-shrink: 0;
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
        }
        .tab-button:not(.active):hover {
            background-color: #e0e7ff;
            color: #4f46e5;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block !important; }

        /* Buttons */
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 0.65rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 0.65rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(107, 114, 128, 0.2);
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(107, 114, 128, 0.3);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
        }

        /* Form Elements */
        .input-field, .select-field, .textarea-field {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1.25rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #f9fafb;
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .input-field-inline {
            padding: 0.6rem 0.8rem;
            border-radius: 0.4rem;
        }

        /* Sidebar Toggle for Mobile */
        .sidebar-toggle {
            display: block;
            background-color: #4f46e5;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: fixed; /* Fixa o botão no topo */
            top: 1rem;
            left: 1rem;
            z-index: 1000; /* Acima de tudo */
        }

        /* Responsive Adjustments */
        @media (min-width: 768px) { /* md breakpoint */
            .sidebar-toggle { display: none; }
            .sidebar {
                transform: translateX(0); /* Always visible on desktop */
            }
            .main-content-area {
                margin-left: 250px; /* Compensate for sidebar width */
            }
            .main-content-area.expanded {
                margin-left: 64px; /* When sidebar is collapsed */
            }
            .flex-container { flex-direction: row; }
            .modal-content { padding: 2rem; }
        }

        /* Mobile Specific Adjustments */
        @media (max-width: 767px) {
            .sidebar {
                transform: translateX(-100%); /* Hidden by default on mobile */
                width: 250px; /* Full width when active */
            }
            .sidebar.active {
                transform: translateX(0); /* Slide in */
            }
            .main-content-area {
                margin-left: 0; /* No margin on mobile */
                padding: 1rem;
            }
            h2 { font-size: 1.8rem; }
            h3 { font-size: 1.2rem; }
            .card { padding: 1.25rem; margin-bottom: 1rem; border-radius: 0.75rem; }
            .grid { gap: 1rem; }
            th, td { padding: 0.75rem 0.8rem; font-size: 0.8rem; }
            .tab-button { padding: 0.6rem 1rem; font-size: 0.85rem; }
            .btn-primary, .btn-secondary { padding: 0.7rem 1.4rem; font-size: 0.9rem; }
            .input-field, .select-field, .textarea-field { padding: 0.7rem; margin-bottom: 1rem; border-radius: 0.4rem; }
            .modal-content { padding: 1.5rem; border-radius: 0.75rem; }
            .modal-close-button { font-size: 1.75rem; top: 0.75rem; right: 1.25rem; }
            .modal-footer { margin-top: 1.25rem; }
            .flex.items-end { flex-direction: column; align-items: stretch; }
            .flex.items-end > div { width: 100%; margin-bottom: 0.5rem; }
            .flex.items-end button { width: 100%; margin-top: 0.5rem; }
        }

        /* Toast Styles */
        #toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 10000;
            display: flex;
            flex-direction: column-reverse;
            gap: 0.75rem;
        }
        .toast {
            background-color: #334155;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.65rem;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            min-width: 250px;
            max-width: 350px;
            word-wrap: break-word;
            font-size: 0.95rem;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            display: none;
            backdrop-filter: blur(3px);
        }
        .loading-spinner {
            border: 5px solid #f3f4f6;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Validation Styles */
        .input-field.invalid, .select-field.invalid, .textarea-field.invalid { border-color: #ef4444; }
        .validation-message {
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: -0.8rem;
            margin-bottom: 1rem;
            display: none;
        }
        .validation-message.show { display: block; }

        /* Low Stock Alert */
        .card.low-stock-alert {
            border: 2px solid #ef4444;
            background-color: #fef2f2;
        }

        /* Styles for expandable movement blocks */
        .movement-block {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.25rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid #e5e7eb;
        }
        .movement-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -2px rgba(0, 0, 0, 0.1), 0 3px 6px -2px rgba(0, 0, 0, 0.08);
        }
        .movement-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #374151;
        }
        .movement-block-details {
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
            display: none;
        }
        .movement-block.expanded .movement-block-details {
            display: block;
        }
        .movement-block-details p {
            margin-bottom: 0.5rem;
            color: #4b5563;
            font-size: 0.9rem;
        }
        .movement-block-details ul {
            list-style: none;
            padding-left: 0;
            margin-top: 0.75rem;
        }
        .movement-block-details ul li {
            background-color: #f9fafb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #374151;
        }
        .movement-block-details ul li:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <!-- Modal de Produção Mínima de Conjuntos -->
    <div id="producaoMinimaModal" class="modal-overlay hidden">
        <div class="modal-content w-full md:max-w-3xl lg:max-w-4xl">
            <button id="closeProducaoMinimaModal" class="modal-close-button" onclick="closeModal('producaoMinimaModal')">&times;</button>
            <h3 class="text-2xl font-semibold text-gray-700 mb-6">Mínimo de Conjuntos para Produção</h3>
            <p class="text-gray-600 mb-4 text-sm">Esta tabela mostra a quantidade mínima de conjuntos que podem ser montados para cada modelo CJA e tipo de tampo, com base nos componentes disponíveis em estoque (Assentos, Encostos, Porta-Livros e Tampos MDF/Plástico).</p>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-2 px-4 text-left">Modelo CJA</th>
                            <th class="py-2 px-4 text-left">Tampo MDF</th>
                            <th class="py-2 px-4 text-left">Tampo Plástico</th>
                        </tr>
                    </thead>
                    <tbody id="producao-minima-table-body" class="text-gray-600 text-sm font-light">
                        <!-- Dados carregados via JavaScript -->
                    </tbody>
                </table>
            </div>
            <p class="text-red-500 text-xs mt-4">
                *Nota: Os dados apresentados aqui são uma simulação para demonstração do frontend. A lógica de cálculo real da produção mínima, que considera apenas Tampos MDF e Plástico (ignorando Masticmol), deve ser implementada e validada no seu **backend Python** para refletir o estoque verdadeiro.*
            </p>
        </div>
    </div>

    <!-- Modal de Movimentações do Dashboard (Mês/Semana) -->
    <div id="dashboardMovementsModal" class="modal-overlay hidden">
        <div class="modal-content w-full md:max-w-3xl lg:max-w-4xl">
            <button id="closeDashboardMovementsModal" class="modal-close-button" onclick="closeModal('dashboardMovementsModal')">&times;</button>
            <h3 class="text-2xl font-semibold text-gray-700 mb-6" id="dashboardMovementsModalTitle">Detalhes das Movimentações</h3>
            <div class="mb-4">
                <label for="search-dashboard-movements" class="block text-gray-700 text-sm font-bold mb-2">Pesquisar por OS:</label>
                <input type="text" id="search-dashboard-movements" class="input-field" placeholder="Digite para pesquisar por OS...">
            </div>
            <div id="dashboard-movements-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Pedidos serão inseridos aqui em blocos -->
            </div>
            <p id="no-dashboard-movements-data" class="no-data mt-4">Nenhuma movimentação encontrada.</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Tela de Login (inicialmente visível) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-96">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login ABC Móveis</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Usuário:</label>
                    <input type="text" id="username" name="username" class="input-field" placeholder="Seu usuário" required>
                    <p id="username-validation" class="validation-message">Campo obrigatório.</p>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Senha:</label>
                    <input type="password" id="password" name="password" class="input-field" placeholder="Sua senha" required>
                    <p id="password-validation" class="validation-message">Campo obrigatório.</p>
                </div>
                <button type="submit" class="btn-primary w-full">Entrar</button>
                <p id="login-message" class="text-red-500 text-sm text-center mt-4 hidden"></p>
            </form>
            <button id="initialize-data-button" class="btn-secondary w-full mt-4 text-sm">Inicializar Dados (Apenas para Teste)</button>
        </div>
    </div>

    <!-- Conteúdo Principal (inicialmente oculto) -->
    <div id="main-content-wrapper" class="min-h-screen flex flex-col md:flex-row flex-container hidden">
        <!-- Sidebar Toggle for Mobile -->
        <button class="sidebar-toggle md:hidden" id="sidebar-toggle-button">☰ Menu</button>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="text-2xl font-bold mb-8 text-center">ABC Móveis</div>
            <nav>
                <ul>
                    <li class="mb-3">
                        <a href="#" id="linkDashboard" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-tachometer-alt mr-3 text-lg"></i>
                            <span class="sidebar-content">Dashboard</span>
                        </a>
                    </li>
                    <li class="mb-3">
                        <a href="#" id="linkEstoqueComponentes" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-box mr-3 text-lg"></i>
                            <span class="sidebar-content">Estoque de Componentes</span>
                        </a>
                    </li>
                    <li class="mb-3">
                        <a href="#" id="linkEstoqueConjuntos" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-boxes mr-3 text-lg"></i>
                            <span class="sidebar-content">Estoque Conjuntos Prontos ABC</span>
                        </a>
                    </li>
                    <li class="mb-3">
                        <a href="#" id="linkEstoqueDistrito" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-warehouse mr-3 text-lg"></i>
                            <span class="sidebar-content">Estoque Distrito</span>
                        </a>
                    </li>
                    <li class="mb-3">
                        <a href="#" id="linkMovimentacoes" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-exchange-alt mr-3 text-lg"></i>
                            <span class="sidebar-content">Movimentações</span>
                        </a>
                    </li>
                    <li class="mb-3" id="nav-pedidos-pendentes-li">
                        <a href="#" id="linkPedidosPendentes" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-hourglass-half mr-3 text-lg"></i>
                            <span class="sidebar-content">Pedidos Pendentes</span>
                        </a>
                    </li>
                    <li class="mb-3" id="nav-registrar-saida-li">
                        <a href="#" id="linkRegistrarSaidaManual" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-clipboard-list mr-3 text-lg"></i>
                            <span class="sidebar-content">Registrar Saída Manual</span>
                        </a>
                    </li>
                    <li class="mb-3">
                        <a href="#" id="linkLogAuditoria" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-history mr-3 text-lg"></i>
                            <span class="sidebar-content">Log de Auditoria</span>
                        </a>
                    </li>
                    <li class="mb-3" id="nav-gerenciamento-usuarios-li">
                        <a href="#" id="linkGerenciamentoUsuarios" class="flex items-center text-gray-200 hover:text-white py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-users mr-3 text-lg"></i>
                            <span class="sidebar-content">Gerenciamento de Usuários</span>
                        </a>
                    </li>
                    <li class="mb-3 mt-auto">
                        <button id="nav-logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded w-full flex items-center justify-center">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            <span class="sidebar-content">Sair (<span id="logged-in-username"></span>)</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 main-content-area">
            <!-- Adicionado para exibir o título da página atual -->
            <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <span id="current-page-title">Dashboard</span>
            </h1>

            <!-- Dashboard Section -->
            <section id="dashboard-view" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-6">
                    <div class="card">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Total de Itens em Estoque</h3>
                        <p class="text-3xl md:text-4xl font-bold text-indigo-600" id="total-items">0</p>
                    </div>
                    <div class="card cursor-pointer hover:bg-gray-50 transition duration-200" id="card-monthly-movements">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Movimentações do Mês</h3>
                        <p class="text-3xl md:text-4xl font-bold text-green-600" id="monthly-movements">0</p>
                    </div>
                    <div class="card cursor-pointer hover:bg-gray-50 transition duration-200" id="card-weekly-movements">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Movimentações da Semana</h3>
                        <p class="text-3xl md:text-4xl font-bold text-blue-600" id="weekly-movements">0</p>
                    </div>
                </div>
                <!-- Produção Mínima de Conjuntos - Link para o Modal -->
                <div class="card mt-6 cursor-pointer hover:bg-gray-50 transition duration-200" id="card-producao-minima-modal">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Produção Mínima de Conjuntos</h3>
                </div>
                <!-- Estoque Baixo Section -->
                <div class="card cursor-pointer hover:bg-gray-50 transition duration-200" id="card-low-stock">
                    <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Itens com Estoque Baixo (Abaixo de 300)</h3>
                    <p class="text-3xl md:text-4xl font-bold text-red-600" id="low-stock-count">0</p>
                </div>
                <div id="low-stock-details-wrapper" class="hidden card mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Detalhes dos Itens com Estoque Baixo</h3>
                    <div class="table-container">
                        <table id="table-low-stock">
                            <thead>
                                <tr>
                                    <th data-sort-key="componente">COMPONENTE</th>
                                    <th data-sort-key="quantidade">QUANTIDADE ATUAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-low-stock-data" class="no-data">Nenhum item com estoque baixo encontrado.</p>
                    </div>
                </div>

                <!-- Produção Mínima Section (Este card agora apenas para visualização de dados no dashboard, o modal é o principal) -->
                <div class="card cursor-pointer hover:bg-gray-50 transition duration-200" id="card-producao-minima">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Produção Mínima de Conjuntos (Dashboard)</h3>
                </div>
                <div id="producao-minima-details-wrapper" class="hidden card mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Mínimo de Conjuntos para Produção (Dashboard Detalhes)</h3>
                    <p class="text-gray-600 mb-4">Esta tabela mostra a quantidade mínima de conjuntos que podem ser montados para cada modelo CJA e tipo de tampo, com base nos componentes disponíveis em estoque (Assentos, Encostos, Porta-Livros e Tampos).</p>
                    <div class="table-container">
                        <table id="table-producao-minima">
                            <thead>
                                <tr>
                                    <th data-sort-key="modelo_cja">MODELO CJA</th>
                                    <th data-sort-key="mdf">MDF</th>
                                    <th data-sort-key="plastico">PLÁSTICO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-producao-minima-data" class="no-data">Nenhum dado de produção mínima encontrado.</p>
                    </div>
                </div>

                <!-- Gráfico de Movimentações Mensais (EXISTENTE) -->
                <div class="card mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Movimentações de Estoque (Últimos 6 Meses)</h3>
                    <div class="relative h-80 w-full"> <!-- Fixed height for chart container -->
                        <canvas id="monthlyMovementsChart"></canvas>
                    </div>
                </div>

                <!-- NOVO: Bloco de Produção por CJA e Tipo de Tampo (com seletores) -->
                <div class="card mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Produção de Conjuntos por Modelo e Tampo</h3>
                    <div class="flex flex-col md:flex-row gap-4 mb-4 items-center">
                        <div class="w-full md:w-1/3">
                            <label for="selectCJA" class="block text-gray-700 text-sm font-bold mb-1">Modelo CJA:</label>
                            <select id="selectCJA" class="select-field">
                                <option value="">Selecione o CJA</option>
                                <option value="CJA-06">CJA-06</option>
                                <option value="CJA-05">CJA-05</option>
                                <option value="CJA-04">CJA-04</option>
                                <option value="CJA-03">CJA-03</option>
                            </select>
                        </div>
                        <div class="w-full md:w-1/3">
                            <label for="selectTampo" class="block text-gray-700 text-sm font-bold mb-1">Tipo de Tampo:</label>
                            <select id="selectTampo" class="select-field">
                                <option value="">Selecione o Tampo</option>
                                <option value="MDF">MDF</option>
                                <option value="PLASTICO">PLÁSTICO</option>
                            </select>
                        </div>
                        <div class="w-full md:w-1/3 flex justify-center md:justify-end gap-2 mt-4 md:mt-0">
                            <button id="producao-cja-semanal-btn" class="btn-primary" onclick="updateCJAProductionChart('weekly', true)">Semanal</button>
                            <button id="producao-cja-mensal-btn" class="btn-secondary" onclick="updateCJAProductionChart('monthly', true)">Mensal</button>
                        </div>
                    </div>
                    <div class="relative h-80 w-full">
                        <canvas id="cjaProductionChart"></canvas>
                    </div>
                    <p id="no-cja-production-chart-data" class="no-data mt-4">Selecione um CJA e um Tampo para ver o gráfico de produção.</p>
                </div>
            </section>

            <!-- Estoque de Componentes Section (Antigo Estoque Atual) -->
            <section id="estoque-componentes-view" class="tab-content">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Estoque de Componentes Detalhado</h2>

                <div class="mb-4">
                    <label for="search-estoque-componentes" class="block text-gray-700 text-sm font-bold mb-2">Pesquisar Componente:</label>
                    <input type="text" id="search-estoque-componentes" class="input-field" placeholder="Digite para pesquisar componentes...">
                </div>

                <!-- Tabela CONJUNTOS ASSENTO/ENCOSTO - ZURICH -->
                <div class="mb-6">
                    <h3 class="text-lg md:text-xl font-medium text-gray-600 mb-3">CONJUNTOS ASSENTO/ENCOSTO - ZURICH</h3>
                    <div class="table-container">
                        <table id="table-zurich">
                            <thead>
                                <tr>
                                    <th data-sort-key="modelo">MODELO</th>
                                    <th data-sort-key="assento">ASSENTO</th>
                                    <th data-sort-key="encosto">ENCOSTO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-data-zurich" class="no-data">Nenhum dado de conjuntos Zurich encontrado.</p>
                    </div>
                </div>

                <!-- Tabela CONJUNTOS ASSENTO/ENCOSTO - MASTICMOL -->
                <div class="mb-6">
                    <h3 class="text-lg md:text-xl font-medium text-gray-600 mb-3">CONJUNTOS ASSENTO/ENCOSTO - MASTICMOL</h3>
                    <div class="table-container">
                        <table id="table-masticmol">
                            <thead>
                                <tr>
                                    <th data-sort-key="modelo">MODELO</th>
                                    <th data-sort-key="assento">ASSENTO</th>
                                    <th data-sort-key="encosto">ENCOSTO</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-data-masticmol" class="no-data">Nenhum dado de conjuntos Masticmol encontrado.</p>
                    </div>
                </div>

                <!-- Tabela PORTA-LIVRO -->
                <div class="mb-6">
                    <h3 class="text-lg md:text-xl font-medium text-gray-600 mb-3">PORTA-LIVRO</h3>
                    <div class="table-container">
                        <table id="table-porta-livro">
                            <thead>
                                <tr>
                                    <th data-sort-key="item">ITEM</th>
                                    <th data-sort-key="quantidade">QUANTIDADE</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-data-porta-livro" class="no-data">Nenhum dado de porta-livro encontrado.</p>
                    </div>
                </div>
                
                <!-- Tabela TAMPOS (CJA por tipo de tampo) -->
                <div class="mb-6">
                    <h3 class="text-lg md:text-xl font-medium text-gray-600 mb-3">TAMPOS</h3>
                    <div class="table-container">
                        <table id="table-tampos">
                            <thead>
                                <tr>
                                    <th data-sort-key="modelo"></th>
                                    <th data-sort-key="mdf">MDF</th>
                                    <th data-sort-key="plastico">PLÁSTICO</th>
                                    <th data-sort-key="masticmol">MASTICMOL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-data-tampos" class="no-data">Nenhum dado de tampos encontrado.</p>
                    </div>
                </div>

                <!-- Formulário de Reajuste de Componentes (Assentos, Encostos, Tampos, Porta-Livros) -->
                <div class="card mt-6" id="reajuste-componentes-card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Reajuste de Componentes</h3>
                    <form id="formReajusteEstoque">
                        <label for="reajusteTipoOperacao" class="block text-gray-700 text-sm font-bold mb-2">Tipo de Operação:</label>
                        <select id="reajusteTipoOperacao" name="tipo_operacao" class="select-field" required>
                            <option value="">Selecione</option>
                            <option value="adicionar">Adicionar ao Estoque</option>
                            <option value="retirar">Retirar do Estoque</option>
                        </select>
                        <p id="reajusteTipoOperacao-validation" class="validation-message">Campo obrigatório.</p>

                        <div id="reajusteDescricaoContainer" class="hidden">
                            <label for="reajusteDescricao" class="block text-gray-700 text-sm font-bold mb-2">Descrição (Ex: Nota Fiscal, Ajuste):</label>
                            <input type="text" id="reajusteDescricao" name="descricao" class="input-field" placeholder="Ex: Compra de componentes - Nota Fiscal #XYZ">
                            <p id="reajusteDescricao-validation" class="validation-message">Campo obrigatório para adição.</p>
                        </div>

                        <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Adicionar/Remover Itens Avulsos:</h4>
                        <div id="reajusteAvulsaItemsContainer">
                            <!-- Itens avulsos serão adicionados aqui dinamicamente pelo JavaScript -->
                            <p class="text-gray-500 text-sm">Nenhum item avulso adicionado ainda.</p>
                        </div>
                        <button type="button" id="add-reajuste-avulsa-item-button" class="btn-secondary w-full md:w-auto mb-4">Adicionar Mais Item Avulso</button>

                        <div class="modal-footer">
                            <button type="submit" class="btn-primary">Registrar Reajuste</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Estoque de Conjuntos Prontos ABC Section -->
            <section id="estoque-conjuntos-view" class="tab-content">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Estoque de Conjuntos Prontos - ABC</h2>
                
                <div class="mb-4">
                    <label for="search-conjuntos-prontos-local" class="block text-gray-700 text-sm font-bold mb-2">Pesquisar Conjunto Pronto Local:</label>
                    <input type="text" id="search-conjuntos-prontos-local" class="input-field" placeholder="Digite para pesquisar conjuntos prontos...">
                </div>

                <!-- Tabela Estoque de Conjuntos Prontos (Local) - Visualização Consolidada -->
                <div class="mb-6">
                    <h3 class="text-lg md:text-xl font-medium text-gray-600 mb-3">CONJUNTOS PRONTOS - LOCAL (ABC)</h3>
                    <div class="table-container">
                        <table id="table-conjuntos-prontos-local">
                            <thead>
                                <tr>
                                    <th data-sort-key="modelo_cja">MODELO CJA</th>
                                    <th data-sort-key="mdf">MDF</th>
                                    <th data-sort-key="plastico">PLÁSTICO</th>
                                    <th data-sort-key="masticmol">MASTICMOL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-data-conjuntos-prontos-local" class="no-data">Nenhum conjunto pronto local encontrado.</p>
                    </div>
                </div>

                <!-- Formulário para Adicionar Conjuntos Prontos - Local -->
                <div class="card mt-6" id="add-conjuntos-prontos-local-card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Conjuntos Prontos ao Estoque Local (ABC)</h3>
                    <form id="formAddConjuntosProntosLocal">
                        <div class="mb-4">
                            <label for="addConjuntosTipoCJALocal" class="block text-gray-700 text-sm font-bold mb-1">Tipo de CJA:</label>
                            <select id="addConjuntosTipoCJALocal" name="tipo_cja" class="select-field" required>
                                <option value="">Selecione o Tipo</option>
                                <option value="ZURICH">ZURICH</option>
                                <option value="MASTICMOL">MASTICMOL</option>
                            </select>
                            <p id="addConjuntosTipoCJALocal-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="addConjuntosModeloCJALocal" class="block text-gray-700 text-sm font-bold mb-1">Modelo CJA:</label>
                            <select id="addConjuntosModeloCJALocal" name="modelo_cja" class="select-field" required>
                                <option value="">Selecione o Modelo</option>
                                <option value="CJA-06">CJA-06</option>
                                <option value="CJA-05">CJA-05</option>
                                <option value="CJA-04">CJA-04</option>
                                <option value="CJA-03">CJA-03</option>
                            </select>
                            <p id="addConjuntosModeloCJALocal-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="addConjuntosTampoTipoLocal" class="block text-gray-700 text-sm font-bold mb-1">Tipo de Tampo:</label>
                            <select id="addConjuntosTampoTipoLocal" name="tampo_tipo" class="select-field" required>
                                <option value="">Selecione o Tampo</option>
                                <option value="MDF">MDF</option>
                                <option value="PLASTICO">PLÁSTICO</option>
                                <option value="MASTICMOL">MASTICMOL</option>
                            </select>
                            <p id="addConjuntosTampoTipoLocal-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="addConjuntosQuantidadeLocal" class="block text-gray-700 text-sm font-bold mb-1">Quantidade de Conjuntos:</label>
                            <input type="number" id="addConjuntosQuantidadeLocal" name="quantidade" class="input-field" min="1" value="1" required>
                            <p id="addConjuntosQuantidadeLocal-validation" class="validation-message">Quantidade deve ser maior que 0.</p>
                        </div>
                        <div class="modal-footer justify-center">
                            <button type="submit" class="btn-primary">Registrar Produção Local</button>
                        </div>
                    </form>
                </div>

                <!-- Formulário para Retirar Conjuntos Prontos - Local -->
                <div class="card mt-6" id="retirar-conjuntos-prontos-local-card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Retirar Conjuntos Prontos do Estoque Local (ABC)</h3>
                    <form id="formRetirarConjuntosProntosLocal">
                        <div class="mb-4">
                            <label for="retirarConjuntosTipoCJALocal" class="block text-gray-700 text-sm font-bold mb-1">Tipo de CJA:</label>
                            <select id="retirarConjuntosTipoCJALocal" name="tipo_cja" class="select-field" required>
                                <option value="">Selecione o Tipo</option>
                                <option value="ZURICH">ZURICH</option>
                                <option value="MASTICMOL">MASTICMOL</option>
                            </select>
                            <p id="retirarConjuntosTipoCJALocal-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="retirarConjuntosModeloCJALocal" class="block text-gray-700 text-sm font-bold mb-1">Modelo CJA:</label>
                            <select id="retirarConjuntosModeloCJALocal" name="modelo_cja" class="select-field" required>
                                <option value="">Selecione o Modelo</option>
                                <option value="CJA-06">CJA-06</option>
                                <option value="CJA-05">CJA-05</option>
                                <option value="CJA-04">CJA-04</option>
                                <option value="CJA-03">CJA-03</option>
                            </select>
                            <p id="retirarConjuntosModeloCJALocal-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="retirarConjuntosTampoTipoLocal" class="block text-gray-700 text-sm font-bold mb-1">Tipo de Tampo:</label>
                            <select id="retirarConjuntosTampoTipoLocal" name="tampo_tipo" class="select-field" required>
                                <option value="">Selecione o Tampo</option>
                                <option value="MDF">MDF</option>
                                <option value="PLASTICO">PLÁSTICO</option>
                                <option value="MASTICMOL">MASTICMOL</option>
                            </select>
                            <p id="retirarConjuntosTampoTipoLocal-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="retirarConjuntosQuantidadeLocal" class="block text-gray-700 text-sm font-bold mb-1">Quantidade de Conjuntos:</label>
                            <input type="number" id="retirarConjuntosQuantidadeLocal" name="quantidade" class="input-field" min="1" value="1" required>
                            <p id="retirarConjuntosQuantidadeLocal-validation" class="validation-message">Quantidade deve ser maior que 0.</p>
                        </div>
                        <div class="modal-footer justify-center">
                            <button type="submit" class="btn-secondary">Retirar do Estoque Local</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Estoque Distrito Section -->
            <section id="estoque-distrito-view" class="tab-content">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Estoque Distrito</h2>
                
                <div class="mb-4">
                    <label for="search-conjuntos-prontos-distrito" class="block text-gray-700 text-sm font-bold mb-2">Pesquisar Conjunto Pronto Distrito:</label>
                    <input type="text" id="search-conjuntos-prontos-distrito" class="input-field" placeholder="Digite para pesquisar conjuntos prontos...">
                </div>

                <!-- Tabela Estoque de Conjuntos Prontos (Distrito) - Visualização Consolidada -->
                <div class="mb-6">
                    <h3 class="text-lg md:text-xl font-medium text-gray-600 mb-3">CONJUNTOS PRONTOS - DISTRITO</h3>
                    <div class="table-container">
                        <table id="table-conjuntos-prontos-distrito">
                            <thead>
                                <tr>
                                    <th data-sort-key="modelo_cja">MODELO CJA</th>
                                    <th data-sort-key="mdf">MDF</th>
                                    <th data-sort-key="plastico">PLÁSTICO</th>
                                    <th data-sort-key="masticmol">MASTICMOL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-data-conjuntos-prontos-distrito" class="no-data">Nenhum conjunto pronto no distrito encontrado.</p>
                    </div>
                </div>

                <!-- Formulário para Adicionar Conjuntos Prontos - Distrito -->
                <div class="card mt-6" id="add-conjuntos-prontos-distrito-card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Conjuntos Prontos ao Estoque Distrito</h3>
                    <form id="formAddConjuntosProntosDistrito">
                        <div class="mb-4">
                            <label for="addConjuntosTipoCJADistrito" class="block text-gray-700 text-sm font-bold mb-1">Tipo de CJA:</label>
                            <select id="addConjuntosTipoCJADistrito" name="tipo_cja" class="select-field" required>
                                <option value="">Selecione o Tipo</option>
                                <option value="ZURICH">ZURICH</option>
                                <option value="MASTICMOL">MASTICMOL</option>
                            </select>
                            <p id="addConjuntosTipoCJADistrito-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="addConjuntosModeloCJADistrito" class="block text-gray-700 text-sm font-bold mb-1">Modelo CJA:</label>
                            <select id="addConjuntosModeloCJADistrito" name="modelo_cja" class="select-field" required>
                                <option value="">Selecione o Modelo</option>
                                <option value="CJA-06">CJA-06</option>
                                <option value="CJA-05">CJA-05</option>
                                <option value="CJA-04">CJA-04</option>
                                <option value="CJA-03">CJA-03</option>
                            </select>
                            <p id="addConjuntosModeloCJADistrito-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="addConjuntosTampoTipoDistrito" class="block text-gray-700 text-sm font-bold mb-1">Tipo de Tampo:</label>
                            <select id="addConjuntosTampoTipoDistrito" name="tampo_tipo" class="select-field" required>
                                <option value="">Selecione o Tampo</option>
                                <option value="MDF">MDF</option>
                                <option value="PLASTICO">PLÁSTICO</option>
                                <option value="MASTICMOL">MASTICMOL</option>
                            </select>
                            <p id="addConjuntosTampoTipoDistrito-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="addConjuntosQuantidadeDistrito" class="block text-gray-700 text-sm font-bold mb-1">Quantidade de Conjuntos:</label>
                            <input type="number" id="addConjuntosQuantidadeDistrito" name="quantidade" class="input-field" min="1" value="1" required>
                            <p id="addConjuntosQuantidadeDistrito-validation" class="validation-message">Quantidade deve ser maior que 0.</p>
                        </div>
                        <div class="modal-footer justify-center">
                            <button type="submit" class="btn-primary">Registrar Produção Distrito</button>
                        </div>
                    </form>
                </div>

                <!-- Formulário para Retirar Conjuntos Prontos - Distrito -->
                <div class="card mt-6" id="retirar-conjuntos-prontos-distrito-card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Retirar Conjuntos Prontos do Estoque Distrito</h3>
                    <form id="formRetirarConjuntosProntosDistrito">
                        <div class="mb-4">
                            <label for="retirarConjuntosTipoCJADistrito" class="block text-gray-700 text-sm font-bold mb-1">Tipo de CJA:</label>
                            <select id="retirarConjuntosTipoCJADistrito" name="tipo_cja" class="select-field" required>
                                <option value="">Selecione o Tipo</option>
                                <option value="ZURICH">ZURICH</option>
                                <option value="MASTICMOL">MASTICMOL</option>
                            </select>
                            <p id="retirarConjuntosTipoCJADistrito-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="retirarConjuntosModeloCJADistrito" class="block text-gray-700 text-sm font-bold mb-1">Modelo CJA:</label>
                            <select id="retirarConjuntosModeloCJADistrito" name="modelo_cja" class="select-field" required>
                                <option value="">Selecione o Modelo</option>
                                <option value="CJA-06">CJA-06</option>
                                <option value="CJA-05">CJA-05</option>
                                <option value="CJA-04">CJA-04</option>
                                <option value="CJA-03">CJA-03</option>
                            </select>
                            <p id="retirarConjuntosModeloCJADistrito-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="retirarConjuntosTampoTipoDistrito" class="block text-gray-700 text-sm font-bold mb-1">Tipo de Tampo:</label>
                            <select id="retirarConjuntosTampoTipoDistrito" name="tampo_tipo" class="select-field" required>
                                <option value="">Selecione o Tampo</option>
                                <option value="MDF">MDF</option>
                                <option value="PLASTICO">PLÁSTICO</option>
                                <option value="MASTICMOL">MASTICMOL</option>
                            </select>
                            <p id="retirarConjuntosTampoTipoDistrito-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="retirarConjuntosQuantidadeDistrito" class="block text-gray-700 text-sm font-bold mb-1">Quantidade de Conjuntos:</label>
                            <input type="number" id="retirarConjuntosQuantidadeDistrito" name="quantidade" class="input-field" min="1" value="1" required>
                            <p id="retirarConjuntosQuantidadeDistrito-validation" class="validation-message">Quantidade deve ser maior que 0.</p>
                        </div>
                        <div class="modal-footer justify-center">
                            <button type="submit" class="btn-secondary">Retirar do Estoque Distrito</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Movimentações Section -->
            <section id="movimentacoes-view" class="tab-content">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Histórico de Movimentações</h2>
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-md">
                    <div class="flex border-b border-gray-200 mb-4">
                        <button id="tab-saidas" class="tab-button active">Saídas (Pedidos/OS)</button>
                        <button id="tab-entradas" class="tab-button">Entradas (Compras/Ajustes)</button>
                        <button id="tab-producao" class="tab-button">Produção (Conjuntos Prontos)</button>
                    </div>

                    <div class="mb-4">
                        <label for="search-movimentacoes" class="block text-gray-700 text-sm font-bold mb-2">Pesquisar Movimentação:</label>
                        <input type="text" id="search-movimentacoes" class="input-field" placeholder="Digite para pesquisar por OS, cidade, etc.">
                    </div>

                    <!-- Saídas (Pedidos/OS) Table -->
                    <div id="saidas-content" class="tab-content active">
                        <div class="table-container">
                            <table id="table-saidas">
                                <thead>
                                    <tr>
                                        <th data-sort-key="timestamp">DATA/HORA</th>
                                        <th data-sort-key="os_number">PEDIDO/OS</th>
                                        <th data-sort-key="cidade_destino">ORIGEM</th>
                                        <th data-sort-key="modelos_resumo">MODELOS & TAMPOS RESUMO</th>
                                        <th data-sort-key="registrado_por">REGISTRADO POR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados serão inseridos aqui pelo JavaScript -->
                                </tbody>
                            </table>
                            <p id="no-saidas-data" class="no-data">Nenhuma saída registrada.</p>
                        </div>
                    </div>

                    <!-- Entradas (Compras/Ajustes) Table -->
                    <div id="entradas-content" class="tab-content">
                        <div class="table-container">
                            <table id="table-entradas">
                                <thead>
                                    <tr>
                                        <th data-sort-key="timestamp">DATA/HORA</th>
                                        <th data-sort-key="tipo_entrada">TIPO</th>
                                        <th data-sort-key="descricao">DESCRIÇÃO</th>
                                        <th data-sort-key="itens_resumo">ITENS</th>
                                        <th data-sort-key="registrado_por">REGISTRADO POR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados serão inseridos aqui pelo JavaScript -->
                                </tbody>
                            </table>
                            <p id="no-entradas-data" class="no-data">Nenhuma entrada registrada.</p>
                        </div>
                    </div>

                    <!-- Produção (Conjuntos Prontos) Table -->
                    <div id="producao-content" class="tab-content">
                        <div class="table-container">
                            <table id="table-producao">
                                <thead>
                                    <tr>
                                        <th data-sort-key="timestamp">DATA/HORA</th>
                                        <th data-sort-key="tipo_cja">TIPO CJA</th>
                                        <th data-sort-key="modelo_cja">MODELO CJA</th>
                                    <th data-sort-key="tampo_tipo">TAMPO</th>
                                        <th data-sort-key="quantidade">QUANTIDADE</th>
                                        <th data-sort-key="destino_estoque">DESTINO</th>
                                        <th data-sort-key="registrado_por">REGISTRADO POR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados serão inseridos aqui pelo JavaScript -->
                                </tbody>
                            </table>
                            <p id="no-producao-data" class="no-data">Nenhuma produção registrada.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pedidos Pendentes Section (APENAS VISUALIZAÇÃO) -->
            <section id="pedidos-pendentes-view" class="tab-content">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Pedidos Pendentes</h2>
                
                <div class="card">
                    <p class="text-gray-600 mb-4">Esta seção exibe pedidos que foram automaticamente registrados via e-mail. Gerencie o status de cada pedido aqui.</p>
                    <div class="mb-4">
                        <label for="search-pending-orders" class="block text-gray-700 text-sm font-bold mb-2">Pesquisar Pedido:</label>
                        <input type="text" id="search-pending-orders" class="input-field" placeholder="Pesquisar por OS, cidade, status...">
                    </div>
                    <div class="table-container">
                        <table id="table-pending-orders">
                            <thead>
                                <tr>
                                    <th data-sort-key="os_number">OS</th>
                                    <th data-sort-key="cidade_destino">CIDADE</th>
                                    <th data-sort-key="itens_resumo">ITENS</th>
                                    <th data-sort-key="status">STATUS</th>
                                    <th data-sort-key="created_at">DATA CRIAÇÃO</th>
                                    <th data-sort-key="created_by">CRIADO POR</th>
                                    <th data-sort-key="updated_at">ÚLTIMA ATUALIZAÇÃO</th>
                                    <th data-sort-key="updated_by">ATUALIZADO POR</th>
                                    <th>AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Pedidos pendentes serão carregados aqui -->
                            </tbody>
                        </table>
                        <p id="no-pending-orders-data" class="no-data">Nenhum pedido pendente encontrado.</p>
                    </div>
                </div>
            </section>

            <!-- Log de Auditoria Section -->
            <section id="log-auditoria-view" class="tab-content">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Log de Auditoria</h2>
                <div class="card">
                    <p class="text-gray-600 mb-4">Esta seção exibe um histórico de todas as ações de movimentação de estoque registradas no sistema.</p>
                    <div class="mb-4">
                        <label for="search-audit-log" class="block text-gray-700 text-sm font-bold mb-2">Pesquisar no Log:</label>
                        <input type="text" id="search-audit-log" class="input-field" placeholder="Pesquisar por usuário, tipo de ação, detalhes...">
                    </div>
                    <div class="table-container">
                        <table id="table-audit-log">
                            <thead>
                                <tr>
                                    <th data-sort-key="timestamp">DATA/HORA</th>
                                    <th data-sort-key="registrado_por">USUÁRIO</th>
                                    <th data-sort-key="tipo">TIPO DE AÇÃO</th>
                                    <th data-sort-key="detalhes">DETALHES</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados do log de auditoria serão inseridos aqui -->
                            </tbody>
                        </table>
                        <p id="no-audit-log-data" class="no-data">Nenhum registro de auditoria encontrado.</p>
                    </div>
                </div>
            </section>

            <!-- Gerenciamento de Usuários Section (Apenas Admin) -->
            <section id="gerenciamento-usuarios-view" class="tab-content">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Gerenciamento de Usuários</h2>

                <!-- Formulário para Criar Novo Usuário -->
                <div class="card mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Criar Novo Usuário</h3>
                    <form id="formCreateUser">
                        <div class="mb-4">
                            <label for="newUsername" class="block text-gray-700 text-sm font-bold mb-2">Usuário:</label>
                            <input type="text" id="newUsername" name="username" class="input-field" placeholder="Nome de usuário" required>
                            <p id="newUsername-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="newPassword" class="block text-gray-700 text-sm font-bold mb-2">Senha:</label>
                            <input type="password" id="newPassword" name="password" class="input-field" placeholder="Senha" required>
                            <p id="newPassword-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <div class="mb-4">
                            <label for="newUserRole" class="block text-gray-700 text-sm font-bold mb-2">Função:</label>
                            <select id="newUserRole" name="role" class="select-field" required>
                                <option value="">Selecione a Função</option>
                                <option value="admin">Administrador</option>
                                <option value="producao">Produção</option>
                                <option value="administrativo">Administrativo</option>
                                <option value="estoque_geral">Estoque Geral</option>
                                <option value="visualizador">Visualizador</option>
                            </select>
                            <p id="newUserRole-validation" class="validation-message">Campo obrigatório.</p>
                        </div>
                        <button type="submit" class="btn-primary w-full md:w-auto">Criar Usuário</button>
                    </form>
                </div>

                <!-- Tabela de Usuários Existentes -->
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Usuários Existentes</h3>
                    <div class="table-container">
                        <table id="table-users">
                            <thead>
                                <tr>
                                    <th data-sort-key="username">Usuário</th>
                                    <th data-sort-key="email">Email</th>
                                    <th data-sort-key="role">Função</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Usuários serão carregados aqui -->
                            </tbody>
                        </table>
                        <p id="no-users-data" class="no-data">Nenhum usuário encontrado.</p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modal para Saída Manual -->
    <div id="saidaManualModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('saidaManualModal')">&times;</button>
            <h3 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4">Registrar Saída Manual (Pedido/OS)</h3>
            
            <form id="formSaidaManual">
                <label for="saidaOsNumber" class="block text-gray-700 text-sm font-bold mb-2">Número da OS:</label>
                <input type="text" id="saidaOsNumber" name="os_number" class="input-field" placeholder="Ex: OS12345" required>
                <p id="saidaOsNumber-validation" class="validation-message">Campo obrigatório.</p>

                <label for="saidaCidadeDestino" class="block text-gray-700 text-sm font-bold mb-2">Cidade de Destino:</label>
                <input type="text" id="saidaCidadeDestino" name="cidade_destino" class="input-field" placeholder="Ex: São Paulo" required>
                <p id="saidaCidadeDestino-validation" class="validation-message">Campo obrigatório.</p>

                <label for="saidaDataEmissao" class="block text-gray-700 text-sm font-bold mb-2">Data de Emissão:</label>
                <input type="date" id="saidaDataEmissao" name="data_emissao" class="input-field" required>
                <p id="saidaDataEmissao-validation" class="validation-message">Campo obrigatório.</p>

                <label for="saidaPrazoEntrega" class="block text-gray-700 text-sm font-bold mb-2">Prazo de Entrega:</label>
                <input type="date" id="saidaPrazoEntrega" name="prazo_entrega" class="input-field" required>
                <p id="saidaPrazoEntrega-validation" class="validation-message">Campo obrigatório.</p>

                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Adicionar Conjuntos Prontos ao Pedido:</h4>
                <div class="mb-4">
                    <label for="saidaConjuntoTipoCJA" class="block text-gray-700 text-sm font-bold mb-1">Tipo de CJA:</label>
                    <select id="saidaConjuntoTipoCJA" class="select-field">
                        <option value="">Selecione o Tipo</option>
                        <option value="ZURICH">ZURICH</option>
                        <option value="MASTICMOL">MASTICMOL</option>
                    </select>
                    <p id="saidaConjuntoTipoCJA-validation" class="validation-message">Campo obrigatório.</p>
                </div>
                <div class="mb-4">
                    <label for="saidaConjuntoModeloCJA" class="block text-gray-700 text-sm font-bold mb-1">Modelo CJA:</label>
                    <select id="saidaConjuntoModeloCJA" class="select-field">
                        <option value="">Selecione o Modelo</option>
                        <option value="CJA-06">CJA-06</option>
                        <option value="CJA-05">CJA-05</option>
                        <option value="CJA-04">CJA-04</option>
                        <option value="CJA-03">CJA-03</option>
                    </select>
                    <p id="saidaConjuntoModeloCJA-validation" class="validation-message">Campo obrigatório.</p>
                </div>
                <div class="mb-4">
                    <label for="saidaConjuntoTampo" class="block text-gray-700 text-sm font-bold mb-1">Tipo de Tampo:</label>
                    <select id="saidaConjuntoTampo" class="select-field">
                        <option value="">Selecione o Tampo</option>
                        <option value="MDF">MDF</option>
                        <option value="PLASTICO">PLÁSTICO</option>
                        <option value="MASTICMOL">MASTICMOL</option>
                    </select>
                    <p id="saidaConjuntoTampo-validation" class="validation-message">Campo obrigatório.</p>
                </div>
                <div class="mb-4">
                    <label for="saidaConjuntoQuantidade" class="block text-gray-700 text-sm font-bold mb-1">Quantidade de Conjuntos:</label>
                    <input type="number" id="saidaConjuntoQuantidade" class="input-field" min="1" value="1" required>
                    <p id="saidaConjuntoQuantidade-validation" class="validation-message">Quantidade deve ser maior que 0.</p>
                </div>
                <button type="button" id="add-saida-conjunto-button" class="btn-primary w-full md:w-auto mb-4">Adicionar Conjunto Selecionado</button>

                <div id="saidaConjuntoItemsContainer" class="mb-4 border p-4 rounded-md bg-gray-50">
                    <!-- Itens do conjunto selecionado serão exibidos aqui -->
                    <p class="text-gray-500 text-sm">Nenhum conjunto adicionado ainda.</p>
                </div>

                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Adicionar Itens Avulsos ao Pedido:</h4>
                <div id="saidaManualItemsContainer">
                    <!-- Itens avulsos serão adicionados aqui dinamicamente pelo JavaScript -->
                    <p class="text-gray-500 text-sm">Nenhum item avulso adicionado ainda.</p>
                </div>
                <button type="button" id="add-saida-item-button" class="btn-secondary w-full md:w-auto mb-4">Adicionar Mais Item Avulso</button>

                <div class="modal-footer">
                    <button type="button" onclick="closeModal('saidaManualModal')" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Registrar Saída</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação Personalizado -->
    <div id="customConfirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('customConfirmModal')">&times;</button>
            <h3 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4" id="confirmModalTitle">Confirmação</h3>
            <p class="text-gray-700 text-base mb-6" id="confirmModalMessage">Você tem certeza?</p>
            <div class="modal-footer">
                <button id="confirmModalCancel" class="btn-secondary">Cancelar</button>
                <button id="confirmModalConfirm" class="btn-primary">Confirmar</button>
            </div>
        </div>
    </div>
    <!-- Firebase SDK e Lógica do Aplicativo -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // URL do seu backend no Render.com
        // ATENÇÃO: SUBSTITUA ESTA URL PELA URL REAL DO SEU SERVIÇO DE BACKEND NO RENDER.COM
        const API_BASE_URL = 'https://estoque-abc-frontend.onrender.com'; // <--- VERIFIQUE E ATUALIZE ESTA URL!

        // Firebase configuration (Hardcoded for GitHub Pages deployment)
        const firebaseConfig = {
            apiKey: "AIzaSyA0NNzu5Uuhoq1IYtiIz3QLJZAzywUwd9M",
            authDomain: "controleestoqueabcmoveis.firebaseapp.com",
            projectId: "controleestoqueabcmoveis",
            storageBucket: "controleestoqueabcmoveis.firebase.app",
            messagingSenderId: "190823747316",
            appId: "1:190823747316:web:305d6cea2c3b2fd5d5d8a1",
            measurementId: "G-23FRRYSS0T"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Variáveis globais para informações do usuário logado
        let currentUser = {
            token: null,
            username: null,
            role: null,
            firebaseUser: null // Armazena o objeto User do Firebase
        };

        // --- Listas de Componentes e Modelos ---
        const CJA_MODELS = ['CJA-06', 'CJA-05', 'CJA-04', 'CJA-03']; 
        const CJA_TYPES = ['ZURICH', 'MASTICMOL'];
        const TAMPO_TYPES = ['MDF', 'PLASTICO', 'MASTICMOL'];

        // Lista completa de todos os componentes individuais para dropdowns
        const ALL_COMPONENTS = [
            'PORTA-LIVRO',
            'ASSENTO-ZURICH-CJA-03', 'ENCOSTO-ZURICH-CJA-03',
            'ASSENTO-ZURICH-CJA-04', 'ENCOSTO-ZURICH-CJA-04',
            'ASSENTO-ZURICH-CJA-05', 'ENCOSTO-ZURICH-CJA-05',
            'ASSENTO-ZURICH-CJA-06', 'ENCOSTO-ZURICH-CJA-06',
            'ASSENTO-MASTICMOL-CJA-03', 'ENCOSTO-MASTICMOL-CJA-03',
            'ASSENTO-MASTICMOL-CJA-04', 'ENCOSTO-MASTICMOL-CJA-04',
            'ASSENTO-MASTICMOL-CJA-05', 'ENCOSTO-MASTICMOL-CJA-05',
            'ASSENTO-MASTICMOL-CJA-06', 'ENCOSTO-MASTICMOL-CJA-06',
            'TAMPO-MDF-CJA-03', 'TAMPO-PLASTICO-CJA-03', 'TAMPO-MASTICMOL-CJA-03',
            'TAMPO-MDF-CJA-04', 'TAMPO-PLASTICO-CJA-04', 'TAMPO-MASTICMOL-CJA-04',
            'TAMPO-MDF-CJA-05', 'TAMPO-PLASTICO-CJA-05', 'TAMPO-MASTICMOL-CJA-05',
            'TAMPO-MDF-CJA-06', 'TAMPO-PLASTICO-CJA-06', 'TAMPO-MASTICMOL-CJA-06'
        ];


        // Variáveis para armazenar os dados brutos das tabelas para pesquisa e ordenação
        let currentEstoqueData = [];
        let currentMovimentacoesData = [];
        let currentUsersData = [];
        let currentLowStockData = [];
        let currentProducaoMinimaData = [];
        let currentAuditLogData = [];
        let currentPendingOrdersData = [];
        // Variável para os dados de movimentações do dashboard (mês/semana)
        let currentDashboardMovementsData = []; 

        // Variáveis para os gráficos
        let monthlyMovementsChartInstance = null;
        let cjaProductionChartInstance = null;

        // Variáveis para os itens de reajuste/saída manual
        let reajusteAvulsaItems = []; // Para itens avulsos no reajuste
        let saidaConjuntoItems = []; // Para conjuntos prontos na saída manual
        let saidaAvulsaItems = []; // Para itens avulsos na saída manual

        let confirmActionCallback = null; // Callback para o modal de confirmação

        // --- Funções de Autenticação ---
        async function login(username, password) {
            try {
                showLoading();
                const userCredential = await signInWithEmailAndPassword(auth, `${username}@example.com`, password);
                const user = userCredential.user;
                
                const idTokenResult = await user.getIdTokenResult();
                
                currentUser.token = idTokenResult.token;
                currentUser.username = user.displayName || username; 
                currentUser.role = idTokenResult.claims.role || 'visualizador'; 
                currentUser.firebaseUser = user;

                hideLoading();
                showMainContent();
                updateLoggedInUserDisplay();
                checkUserRoleAccess();
                showSection('dashboard-view'); // Usar showSection para carregar a view correta
                showToast('Login bem-sucedido!', 'success');
                return true;
            } catch (error) {
                hideLoading();
                console.error('Erro ao fazer login:', error);
                let errorMessage = 'Erro desconhecido ao fazer login.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Usuário ou senha inválidos.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Muitas tentativas de login. Tente novamente mais tarde.';
                }
                displayLoginMessage(errorMessage);
                showToast(errorMessage, 'error');
                return false;
            }
        }

        async function logout() {
            try {
                showLoading();
                await signOut(auth);
                hideLoading();
                showToast('Logout bem-sucedido!', 'info');
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                showToast('Erro ao fazer logout. Por favor, tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        }

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-content-wrapper').classList.add('hidden');
            document.getElementById('login-form').reset();
            displayLoginMessage(''); 
        }

        function showMainContent() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-content-wrapper').classList.remove('hidden');
        }

        function displayLoginMessage(message) {
            const loginMessageElement = document.getElementById('login-message');
            loginMessageElement.textContent = message;
            loginMessageElement.classList.remove('hidden');
            if (!message) {
                loginMessageElement.classList.add('hidden');
            }
        }

        function updateLoggedInUserDisplay() {
            const usernameSpan = document.getElementById('logged-in-username');
            if (usernameSpan) {
                usernameSpan.textContent = currentUser.username || 'Convidado';
            }
        }

        function checkUserRoleAccess() {
            const reajusteComponentesCard = document.getElementById('reajuste-componentes-card');
            const addConjuntosProntosLocalCard = document.getElementById('add-conjuntos-prontos-local-card');
            const retirarConjuntosProntosLocalCard = document.getElementById('retirar-conjuntos-prontos-local-card'); 
            const addConjuntosProntosDistritoCard = document.getElementById('add-conjuntos-prontos-distrito-card');
            const retirarConjuntosProntosDistritoCard = document.getElementById('retirar-conjuntos-prontos-distrito-card'); 
            const registrarSaidaLi = document.getElementById('nav-registrar-saida-li');
            const gerenciamentoUsuariosLi = document.getElementById('nav-gerenciamento-usuarios-li');
            const pedidosPendentesLi = document.getElementById('nav-pedidos-pendentes-li'); 

            const allowedToModify = ['producao', 'administrativo', 'admin', 'estoque_geral'];

            if (allowedToModify.includes(currentUser.role)) {
                reajusteComponentesCard?.classList.remove('hidden');
                addConjuntosProntosLocalCard?.classList.remove('hidden');
                retirarConjuntosProntosLocalCard?.classList.remove('hidden'); 
                addConjuntosProntosDistritoCard?.classList.remove('hidden');
                retirarConjuntosProntosDistritoCard?.classList.remove('hidden'); 
                registrarSaidaLi?.classList.remove('hidden');
                pedidosPendentesLi?.classList.remove('hidden'); 
            } else {
                reajusteComponentesCard?.classList.add('hidden');
                addConjuntosProntosLocalCard?.classList.add('hidden');
                retirarConjuntosProntosLocalCard?.classList.add('hidden'); 
                addConjuntosProntosDistritoCard?.classList.add('hidden');
                retirarConjuntosProntosDistritoCard?.classList.add('hidden'); 
                registrarSaidaLi?.classList.add('hidden');
                pedidosPendentesLi?.classList.add('hidden'); 
            }

            if (currentUser.role === 'admin') {
                gerenciamentoUsuariosLi?.classList.remove('hidden');
            } else {
                gerenciamentoUsuariosLi?.classList.add('hidden');
            }
        }

        // --- Funções de Navegação e Modais ---
        function toggleSidebar() { 
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content-wrapper'); // Usar main-content-wrapper
            if (sidebar && mainContent) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
                // For mobile, also toggle 'active' class
                if (window.innerWidth < 768) {
                    sidebar.classList.toggle('active'); // Use active for mobile sidebar
                }
            } else {
                console.error('Elemento #sidebar ou #main-content-wrapper não encontrado.');
            }
        }

        function showSection(sectionId) { 
            console.log(`Função showSection chamada para: ${sectionId}`); 

            // Remove a classe 'active' de todas as seções
            document.querySelectorAll('.tab-content').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetView = document.getElementById(sectionId);
            if (targetView) {
                targetView.classList.add('active'); // Adiciona a classe 'active' à seção alvo
                const displayTitles = { // Mapeamento de IDs de SEÇÃO para TÍTULOS de exibição
                    'dashboard-view': 'Dashboard',
                    'estoque-componentes-view': 'Estoque de Componentes',
                    'estoque-conjuntos-view': 'Estoque Conjuntos Prontos ABC',
                    'estoque-distrito-view': 'Estoque Distrito',
                    'movimentacoes-view': 'Movimentações',
                    'pedidos-pendentes-view': 'Pedidos Pendentes',
                    'log-auditoria-view': 'Log de Auditoria',
                    'gerenciamento-usuarios-view': 'Gerenciamento de Usuários'
                };
                const currentPageTitleElement = document.getElementById('current-page-title');
                if (currentPageTitleElement) {
                    currentPageTitleElement.textContent = displayTitles[sectionId] || 'Página';
                } else {
                    console.error('Elemento #current-page-title não encontrado para atualizar o título da página.');
                }
                
                // Chamadas de fetch específicas para a view
                if (sectionId === 'estoque-componentes-view') {
                    loadEstoque();
                } else if (sectionId === 'estoque-conjuntos-view') {
                    loadEstoque(); // Reutiliza loadEstoque para popular as tabelas de conjuntos
                } else if (sectionId === 'estoque-distrito-view') {
                    loadEstoque(); // Reutiliza loadEstoque para popular as tabelas de distrito
                } else if (sectionId === 'movimentacoes-view') {
                    loadMovimentacoes();
                } else if (sectionId === 'dashboard-view') {
                    loadDashboardData();
                } else if (sectionId === 'gerenciamento-usuarios-view') {
                    loadUsers(); 
                } else if (sectionId === 'log-auditoria-view') { 
                    loadAuditLogs();
                } else if (sectionId === 'pedidos-pendentes-view') { 
                    loadPendingOrders();
                }
            } else {
                console.error(`Elemento de seção com ID ${sectionId} não encontrado.`);
            }
        }

        // Fix: Ensure openModal and closeModal are globally accessible or defined before use
        function openModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('open'); // Usa 'open' para o modal-overlay
                modal.classList.remove('hidden');
            } else {
                console.error(`Elemento de modal com ID ${modalId} não encontrado.`);
            }
        }

        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('open');
                modal.classList.add('hidden');
            } else {
                console.error(`Elemento de modal com ID ${modalId} não encontrado.`);
            }
        }

        // Função showMovementType (para tabs de Movimentações)
        function showMovementType(type, clickedButtonElement) { 
            document.querySelectorAll('#movimentacoes-view .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            if (clickedButtonElement) {
                clickedButtonElement.classList.add('active');
            }

            const targetContent = document.getElementById(`${type}-content`);
            document.querySelectorAll('#movimentacoes-view .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            if (targetContent) {
                targetContent.classList.add('active');
            } else {
                console.error(`Elemento de conteúdo alvo com ID ${type}-content não encontrado.`);
            }
            filterTable('search-movimentacoes', currentMovimentacoesData, populateMovimentacoesTable, true);
        }

        function toggleVisibility(elementId) { 
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.toggle('hidden');
            }
        }

        // --- Loading Overlay Functions ---
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.body.classList.remove('loaded');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.body.classList.add('loaded');
        }

        // --- Toast Notification Functions ---
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);

            void toast.offsetWidth; 
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // --- Funções de Validação de Formulário ---
        function validateField(inputElement, validationMessageElement) {
            if (!inputElement || !validationMessageElement) return true; 

            let isValid = true;
            let message = '';

            if (inputElement.hasAttribute('required') && inputElement.value.trim() === '') {
                isValid = false;
                message = 'Campo obrigatório.';
            } else if (inputElement.type === 'number' && inputElement.min && parseInt(inputElement.value) < parseInt(inputElement.min)) {
                isValid = false;
                message = `Quantidade deve ser maior ou igual a ${inputElement.min}.`;
            } else if (inputElement.tagName === 'SELECT' && inputElement.value === '') {
                isValid = false;
                message = 'Selecione uma opção.';
            }

            if (!isValid) {
                inputElement.classList.add('invalid');
                validationMessageElement.textContent = message;
                validationMessageElement.classList.add('show');
            } else {
                inputElement.classList.remove('invalid');
                validationMessageElement.classList.remove('show');
            }
            return isValid;
        }

        function validateForm(formId) {
            const form = document.getElementById(formId);
            let allValid = true;
            form.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
                const validationMessageElement = document.getElementById(`${input.id}-validation`);
                if (!validateField(input, validationMessageElement)) {
                    allValid = false;
                }
            });
            return allValid;
        }

        // --- Funções de Pesquisa e Ordenação ---
        function filterTable(searchInputId, dataArray, populateFunction, isMovementTable = false, isAuditLogTable = false, isPendingOrderTable = false, isDashboardMovementList = false) {
            const searchTerm = document.getElementById(searchInputId).value.toLowerCase();
            let filteredData = [];

            if (isMovementTable) {
                const activeTab = document.querySelector('#movimentacoes-view .tab-button.active');
                let movementType = '';
                if (activeTab && activeTab.id === 'tab-saidas') movementType = 'Saída - Pedido';
                else if (activeTab && activeTab.id === 'tab-entradas') movementType = 'Entrada - Manual';
                else if (activeTab && activeTab.id === 'tab-producao') movementType = 'Produção - Conjunto Pronto';

                filteredData = dataArray.filter(item => {
                    const matchesType = item.tipo === movementType;
                    const matchesSearch = JSON.stringify(item).toLowerCase().includes(searchTerm);
                    return matchesType && matchesSearch;
                });
            } else if (isAuditLogTable) { 
                filteredData = dataArray.filter(item => JSON.stringify(item).toLowerCase().includes(searchTerm));
            } else if (isPendingOrderTable) { 
                filteredData = dataArray.filter(item => JSON.stringify(item).toLowerCase().includes(searchTerm));
            } else if (isDashboardMovementList) {
                filteredData = dataArray.filter(item => {
                    const osMatch = item.os_number && item.os_number.toLowerCase().includes(searchTerm);
                    const cityMatch = item.cidade_destino && item.cidade_destino.toLowerCase().includes(searchTerm);
                    return osMatch || cityMatch;
                });
            }
            else {
                // General filter for any table
                filteredData = dataArray.filter(item => JSON.stringify(item).toLowerCase().includes(searchTerm));
            }
            
            populateFunction(filteredData);
        }

        function sortTable(tableId, dataArray, populateFunction, sortKey, isNumeric = false) {
            const table = document.getElementById(tableId);
            const header = table.querySelector(`th[data-sort-key="${sortKey}"]`);
            if (!header) {
                console.warn(`Header with data-sort-key="${sortKey}" not found for table ${tableId}.`);
                return;
            }
            let sortOrder = 'asc';

            table.querySelectorAll('th').forEach(th => {
                if (th !== header) {
                    th.classList.remove('asc', 'desc');
                }
            });

            if (header.classList.contains('asc')) {
                sortOrder = 'desc';
                header.classList.remove('asc');
                header.classList.add('desc');
            } else {
                sortOrder = 'asc';
                header.classList.remove('desc');
                header.classList.add('asc');
            }

            dataArray.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (isNumeric) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else if (sortKey.includes('timestamp') || sortKey.includes('date') || sortKey.includes('created_at') || sortKey.includes('updated_at')) { 
                    valA = new Date(valA).getTime();
                    valB = new Date(valB).getTime();
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) {
                    return sortOrder === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return sortOrder === 'asc' ? 1 : -1;
                }
                return 0;
            });

            populateFunction(dataArray);
        }


        // --- Funções de Carregamento de Dados ---

        async function fetchData(endpoint) {
            showLoading();
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });
                if (!response.ok) {
                    if (response.status === 401) { 
                        showToast('Sessão expirada ou não autenticada. Por favor, faça login novamente.', 'error');
                        logout(); 
                        return null;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Dados recebidos de ${endpoint}:`, data); 
                return data;
            } catch (error) {
                console.error(`Erro ao buscar dados de ${endpoint}:`, error);
                showToast(`Erro ao carregar dados: ${error.message}`, 'error');
                return null;
            } finally {
                hideLoading();
            }
        }

        async function postData(endpoint, data) {
            showLoading();
            try {
                data.registrado_por = currentUser.username; 

                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    if (response.status === 401) { 
                        showToast('Sessão expirada ou não autenticada. Por favor, faça login novamente.', 'error');
                        logout(); 
                        return null;
                    }
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorJson.message || errorText}`);
                    } catch (parseError) {
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                }
                showToast('Operação realizada com sucesso!', 'success');
                return await response.json();
            } catch (error) {
                console.error('Erro ao enviar dados:', error);
                showToast(`Erro ao registrar movimentação: ${error.message}`, 'error'); 
                return null;
            } finally {
                hideLoading();
            }
        }

        async function putData(endpoint, data) {
            showLoading();
            try {
                data.updated_by = currentUser.username; 

                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    if (response.status === 401) { 
                        showToast('Sessão expirada ou não autenticada. Por favor, faça login novamente.', 'error');
                        logout(); 
                        return null;
                    }
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorJson.message || errorText}`);
                    } catch (parseError) {
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                }
                showToast('Operação realizada com sucesso!', 'success');
                return await response.json();
            } catch (error) {
                console.error('Erro ao atualizar dados:', error);
                showToast(`Erro ao atualizar: ${error.message}`, 'error'); 
                return null;
            } finally {
                hideLoading();
            }
        }

        async function deleteData(endpoint) {
            showLoading();
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                });
                if (!response.ok) {
                    if (response.status === 401) { 
                        showToast('Sessão expirada ou não autenticada. Por favor, faça login novamente.', 'error');
                        logout(); 
                        return null;
                    }
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorJson.message || errorText}`);
                    } catch (parseError) {
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                }
                showToast('Item deletado com sucesso!', 'success');
                return await response.json();
            } catch (error) {
                console.error('Erro ao deletar dados:', error);
                showToast(`Erro ao deletar: ${error.message}`, 'error'); 
                return null;
            } finally {
                hideLoading();
            }
        }


        async function loadEstoque() {
            const estoqueData = await fetchData('/estoque');
            if (estoqueData) {
                currentEstoqueData = estoqueData; 
                populateEstoqueTables(estoqueData);
            }
        }

        function populateEstoqueTables(data) {
            const stockMap = {};
            data.forEach(item => {
                stockMap[item.modelo] = item.quantidade;
            });

            const populateSpecificTable = (tableId, noDataId, models, typePrefix = null, isTampo = false) => {
                const tableBody = document.getElementById(tableId);
                const noDataElement = document.getElementById(noDataId);
                if (!tableBody || !tableBody.getElementsByTagName('tbody')[0]) {
                    console.error(`Elemento #${tableId} ou seu tbody não encontrado.`);
                    return;
                }
                const tbody = tableBody.getElementsByTagName('tbody')[0];
                tbody.innerHTML = ''; 
                let hasData = false;

                if (isTampo) {
                    const cjaModelsForTampos = CJA_MODELS; 
                    const tampoTypes = ['MDF', 'PLASTICO', 'MASTICMOL'];

                    cjaModelsForTampos.forEach(model => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-gray-50';
                        let rowHtml = `<td class="py-3 px-6 text-left">${model}</td>`;
                        
                        tampoTypes.forEach(tampoType => {
                            const key = `TAMPO-${tampoType.toUpperCase()}-${model}`; 
                            const quantity = stockMap[key] || 0;
                            rowHtml += `<td class="py-3 px-6 text-left">${quantity}</td>`;
                        });

                        row.innerHTML = rowHtml;
                        tbody.appendChild(row);
                        hasData = true;
                    });
                } else if (typePrefix === 'CONJUNTO-PRONTO-LOCAL' || typePrefix === 'CONJUNTO-PRONTO-DISTRITO') {
                    const cjaModels = CJA_MODELS; 
                    const tampoTypes = ['MDF', 'PLASTICO', 'MASTICMOL'];
                    const cjaTypes = ['ZURICH', 'MASTICMOL']; 

                    cjaModels.forEach(model => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-100';
                        let rowHtml = `<td class="py-3 px-6 text-left">${model}</td>`;
                        
                        tampoTypes.forEach(tampoType => {
                            let totalQuantity = 0;
                            cjaTypes.forEach(cjaType => {
                                const key = `${typePrefix}-${cjaType}-${model}-${tampoType.toUpperCase()}`;
                                totalQuantity += stockMap[key] || 0;
                            });
                            rowHtml += `<td class="py-3 px-6 text-left">${totalQuantity}</td>`;
                        });

                        row.innerHTML = rowHtml;
                        tbody.appendChild(row);
                        hasData = true; 
                    });
                } else {
                    models.forEach(model => {
                        const assentoZurichQty = stockMap[`ASSENTO-ZURICH-${model}`] || 0;
                        const encostoZurichQty = stockMap[`ENCOSTO-ZURICH-${model}`] || 0;
                        const assentoMasticmolQty = stockMap[`ASSENTO-MASTICMOL-${model}`] || 0;
                        const encostoMasticmolQty = stockMap[`ENCOSTO-MASTICMOL-${model}`] || 0;
                        const portaLivroQty = stockMap['PORTA-LIVRO'] || 0; 

                        hasData = true; 
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-100';
                        if (tableId === 'table-porta-livro') {
                            row.innerHTML = `
                                <td class="py-3 px-6 text-left">PORTA-LIVRO</td>
                                <td class="py-3 px-6 text-left">${portaLivroQty}</td>
                            `;
                        } else if (typePrefix === 'ZURICH') {
                            row.innerHTML = `
                                <td class="py-3 px-6 text-left">${model}</td>
                                <td class="py-3 px-6 text-left">${assentoZurichQty}</td>
                                <td class="py-3 px-6 text-left">${encostoZurichQty}</td>
                            `;
                        } else if (typePrefix === 'MASTICMOL') {
                            row.innerHTML = `
                                <td class="py-3 px-6 text-left">${model}</td>
                                <td class="py-3 px-6 text-left">${assentoMasticmolQty}</td>
                                <td class="py-3 px-6 text-left">${encostoMasticmolQty}</td>
                            `;
                        }
                        tbody.appendChild(row);
                    });
                }

                if (noDataElement) {
                    noDataElement.style.display = hasData ? 'none' : 'block';
                }
            };

            populateSpecificTable('table-zurich', 'no-data-zurich', CJA_MODELS, 'ZURICH');
            populateSpecificTable('table-masticmol', 'no-data-masticmol', CJA_MODELS, 'MASTICMOL');
            populateSpecificTable('table-porta-livro', 'no-data-porta-livro', ['PORTA-LIVRO']);
            populateSpecificTable('table-tampos', 'no-data-tampos', [], null, true);
            populateSpecificTable('table-conjuntos-prontos-local', 'no-data-conjuntos-prontos-local', [], 'CONJUNTO-PRONTO-LOCAL');
            populateSpecificTable('table-conjuntos-prontos-distrito', 'no-data-conjuntos-prontos-distrito', [], 'CONJUNTO-PRONTO-DISTRITO');
        }


        async function loadMovimentacoes() {
            const movimentacoesData = await fetchData('/movimentacoes');
            if (movimentacoesData) {
                currentMovimentacoesData = movimentacoesData; 
                populateMovimentacoesTable(movimentacoesData);
            }
        }

        function populateMovimentacoesTable(data) {
            const saidasTableBody = document.getElementById('table-saidas');
            const noSaidasData = document.getElementById('no-saidas-data');
            const entradasTableBody = document.getElementById('table-entradas');
            const noEntradasData = document.getElementById('no-entradas-data');
            const producaoTableBody = document.getElementById('table-producao');
            const noProducaoData = document.getElementById('no-producao-data');

            [saidasTableBody, entradasTableBody, producaoTableBody].forEach(table => {
                if (table && table.getElementsByTagName('tbody')[0]) {
                    table.getElementsByTagName('tbody')[0].innerHTML = '';
                }
            });

            let hasSaidas = false;
            let hasEntradas = false;
            let hasProducao = false;

            data.forEach(mov => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                const timestampFormatted = mov.timestamp ? new Date(mov.timestamp).toLocaleString('pt-BR') : 'N/A';
                const registradoPor = mov.registrado_por || 'N/A';

                if (mov.tipo === "Saída - Pedido") { 
                    hasSaidas = true;
                    const conjuntosPedidos = mov.itens.map(item => {
                        let itemStr = `${item.quantidade}x `;
                        // Ajuste para exibir corretamente o nome do item
                        if (item.modelo_cja && item.tampo_tipo) {
                            itemStr += `${item.tipo_cja || ''} ${item.modelo_cja} (Tampo: ${item.tampo_tipo})`;
                        } else if (item.componente) {
                            itemStr += item.componente;
                        } else {
                            itemStr += 'N/A';
                        }
                        return itemStr;
                    }).join(', ');

                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${timestampFormatted}</td>
                        <td class="py-3 px-6 text-left">${mov.os_number}</td>
                        <td class="py-3 px-6 text-left">${mov.cidade_destino || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">
                            <button onclick="showOrderDetailsModal('${mov.os_number}', ${escape(JSON.stringify(mov.itens))}, '${mov.cidade_destino}', '${mov.data_emissao}', '${mov.prazo_entrega}')" class="text-indigo-500 hover:underline">
                                ${conjuntosPedidos}
                            </button>
                        </td>
                        <td class="py-3 px-6 text-left">${registradoPor}</td>
                    `;
                    saidasTableBody.getElementsByTagName('tbody')[0].appendChild(row);
                } else if (mov.tipo === "Entrada - Manual") { 
                    hasEntradas = true;
                    const itensResumo = mov.itens.map(item => {
                        let itemStr = `${item.quantidade}x `;
                        itemStr += item.componente || 'N/A';
                        return itemStr;
                    }).join(', ');

                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${timestampFormatted}</td>
                        <td class="py-3 px-6 text-left">${mov.tipo_entrada || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${mov.descricao || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${itensResumo}</td>
                        <td class="py-3 px-6 text-left">${registradoPor}</td>
                    `;
                    entradasTableBody.getElementsByTagName('tbody')[0].appendChild(row);
                } else if (mov.tipo === "Produção - Conjunto Pronto") { 
                    hasProducao = true;
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${timestampFormatted}</td>
                        <td class="py-3 px-6 text-left">${mov.tipo_cja || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${mov.modelo_cja || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${mov.tampo_tipo || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${mov.quantidade || 0}</td>
                        <td class="py-3 px-6 text-left">${mov.destino_estoque || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${registradoPor}</td>
                    `;
                    producaoTableBody.getElementsByTagName('tbody')[0].appendChild(row);
                }
            });

            if (noSaidasData) noSaidasData.style.display = hasSaidas ? 'none' : 'block';
            if (noEntradasData) noEntradasData.style.display = hasEntradas ? 'none' : 'block';
            if (noProducaoData) noProducaoData.style.display = hasProducao ? 'none' : 'block';
        }

        async function loadDashboardData() {
            const estoqueData = await fetchData('/estoque');
            const movimentacoesData = await fetchData('/movimentacoes');

            if (estoqueData) {
                let totalItems = 0;
                const stockMap = {};
                estoqueData.forEach(item => {
                    stockMap[item.modelo] = item.quantidade;
                });

                for (const key in stockMap) {
                    totalItems += stockMap[key];
                }
                const totalItemsElement = document.getElementById('total-items'); 
                if (totalItemsElement) {
                    totalItemsElement.textContent = totalItems;
                } else {
                    console.error('Elemento #total-items não encontrado no dashboard.');
                }

                const lowStockTableBody = document.getElementById('table-low-stock');
                const noLowStockData = document.getElementById('no-low-stock-data');
                const lowStockCard = document.getElementById('card-low-stock');
                const lowStockCountElement = document.getElementById('low-stock-count');

                if (lowStockTableBody && lowStockTableBody.getElementsByTagName('tbody')[0]) {
                    const tbody = lowStockTableBody.getElementsByTagName('tbody')[0];
                    tbody.innerHTML = '';
                    let hasLowStock = false;
                    let lowStockItemCount = 0;
                    const LOW_STOCK_THRESHOLD = 300;
                    currentLowStockData = []; 

                    // Usar ALL_COMPONENTS para verificar estoque baixo
                    ALL_COMPONENTS.forEach(componentName => {
                        const quantity = stockMap[componentName] || 0;
                        if (quantity <= LOW_STOCK_THRESHOLD && quantity > 0) { 
                            hasLowStock = true;
                            lowStockItemCount++;
                            currentLowStockData.push({ componente: componentName, quantidade: quantity });
                        }
                    });
                    
                    // Adicionar conjuntos prontos à verificação de estoque baixo
                    const ALL_CONJUNTOS_PRONTOS = [];
                    CJA_TYPES.forEach(cjaType => {
                        CJA_MODELS.forEach(cjaModel => {
                            TAMPO_TYPES.forEach(tampoType => {
                                ALL_CONJUNTOS_PRONTOS.push(`CONJUNTO-PRONTO-LOCAL-${cjaType}-${cjaModel}-${tampoType}`);
                                ALL_CONJUNTOS_PRONTOS.push(`CONJUNTO-PRONTO-DISTRITO-${cjaType}-${cjaModel}-${tampoType}`);
                            });
                        });
                    });

                    ALL_CONJUNTOS_PRONTOS.forEach(conjuntoName => {
                        const quantity = stockMap[conjuntoName] || 0;
                        if (quantity <= LOW_STOCK_THRESHOLD && quantity > 0) {
                            hasLowStock = true;
                            lowStockItemCount++;
                            currentLowStockData.push({ componente: conjuntoName, quantidade: quantity });
                        }
                    });


                    if (lowStockCountElement) {
                        lowStockCountElement.textContent = lowStockItemCount;
                    }
                    if (lowStockCard) {
                        if (lowStockItemCount > 0) {
                            lowStockCard.classList.add('low-stock-alert');
                        } else {
                            lowStockCard.classList.remove('low-stock-alert');
                        }
                    }

                    populateLowStockTable(currentLowStockData); 
                    if (noLowStockData) {
                        noLowStockData.style.display = hasLowStock ? 'none' : 'block';
                    }
                } else {
                    console.error('Elemento #table-low-stock ou seu tbody não encontrado.');
                }
                populateProducaoMinima(estoqueData); 
            }

            if (movimentacoesData) {
                const today = new Date();
                const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                const oneWeekAgo = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);

                // Filter and store monthly/weekly movements
                const monthlyMovements = movimentacoesData.filter(mov => {
                    const movDate = mov.timestamp ? new Date(mov.timestamp) : null;
                    // Filter only "Saída - Pedido" for dashboard movements
                    return movDate && mov.tipo === "Saída - Pedido" && movDate >= oneMonthAgo;
                });
                const weeklyMovements = movimentacoesData.filter(mov => {
                    const movDate = mov.timestamp ? new Date(mov.timestamp) : null;
                    // Filter only "Saída - Pedido" for dashboard movements
                    return movDate && mov.tipo === "Saída - Pedido" && movDate >= oneWeekAgo;
                });

                // Update dashboard counts
                const monthlyMovementsElement = document.getElementById('monthly-movements');
                if (monthlyMovementsElement) monthlyMovementsElement.textContent = monthlyMovements.length;
                const weeklyMovementsElement = document.getElementById('weekly-movements');
                if (weeklyMovementsElement) weeklyMovementsElement.textContent = weeklyMovements.length;

                // Store these for the dashboard movements modal
                currentDashboardMovementsData = {
                    monthly: monthlyMovements,
                    weekly: weeklyMovements
                };

                renderMonthlyMovementsChart(movimentacoesData); 
            }
        }

        function populateLowStockTable(data) {
            const tbody = document.getElementById('table-low-stock').getElementsByTagName('tbody')[0];
            const noDataElement = document.getElementById('no-low-stock-data');
            tbody.innerHTML = '';
            if (data.length > 0) {
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${item.componente}</td>
                        <td class="py-3 px-6 text-left">${item.quantidade}</td>
                    `;
                    tbody.appendChild(row);
                });
                noDataElement.style.display = 'none';
            } else {
                noDataElement.style.display = 'block';
            }
        }

        // Nova função para abrir o modal de movimentações do dashboard
        function openDashboardMovementsModal(type) {
            const modalTitle = document.getElementById('dashboardMovementsModalTitle');
            const searchInput = document.getElementById('search-dashboard-movements');
            const listContainer = document.getElementById('dashboard-movements-list');
            const noDataMessage = document.getElementById('no-dashboard-movements-data');

            let dataToDisplay = [];
            if (type === 'monthly') {
                modalTitle.textContent = 'Movimentações do Mês';
                dataToDisplay = currentDashboardMovementsData.monthly;
            } else if (type === 'weekly') {
                modalTitle.textContent = 'Movimentações da Semana';
                dataToDisplay = currentDashboardMovementsData.weekly;
            }

            // Store the current data being displayed in the modal for filtering
            listContainer.dataset.currentData = JSON.stringify(dataToDisplay);

            // Populate the list initially
            populateDashboardMovementList(dataToDisplay);

            // Clear search input and attach event listener for filtering
            searchInput.value = '';
            searchInput.oninput = () => {
                const filtered = JSON.parse(listContainer.dataset.currentData).filter(item => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const osMatch = item.os_number && item.os_number.toLowerCase().includes(searchTerm);
                    const cityMatch = item.cidade_destino && item.cidade_destino.toLowerCase().includes(searchTerm);
                    return osMatch || cityMatch;
                });
                populateDashboardMovementList(filtered);
            };

            openModal('dashboardMovementsModal');
        }

        // Função para popular a lista de movimentações no modal do dashboard
        function populateDashboardMovementList(data) {
            const listContainer = document.getElementById('dashboard-movements-list');
            const noDataMessage = document.getElementById('no-dashboard-movements-data');
            listContainer.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(mov => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'movement-block'; // Use a classe customizada
                    
                    const dataEmissaoFormatada = mov.data_emissao ? new Date(mov.data_emissao).toLocaleDateString('pt-BR') : 'N/A';

                    itemDiv.innerHTML = `
                        <div class="movement-block-header">
                            <div>
                                <p>OS: ${mov.os_number}</p>
                                <p>Município: ${mov.cidade_destino || 'N/A'}</p>
                                <p>Data: ${dataEmissaoFormatada}</p>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="movement-block-details">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Itens do Pedido:</h4>
                            <ul>
                                ${mov.itens.map(item => {
                                    let itemDisplay = `${item.quantidade}x `;
                                    if (item.modelo_cja && item.tampo_tipo) {
                                        itemDisplay += `${item.tipo_cja || ''} ${item.modelo_cja} (Tampo: ${item.tampo_tipo})`;
                                    } else if (item.componente) {
                                        itemDisplay += item.componente;
                                    } else {
                                        itemDisplay += 'N/A';
                                    }
                                    return `<li><span>${itemDisplay}</span></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    `;
                    itemDiv.onclick = (event) => {
                        // Toggle the 'expanded' class on the clicked block
                        itemDiv.classList.toggle('expanded');
                        // Toggle the chevron icon
                        const icon = itemDiv.querySelector('.movement-block-header i');
                        if (icon) {
                            if (itemDiv.classList.contains('expanded')) {
                                icon.classList.remove('fa-chevron-down');
                                icon.classList.add('fa-chevron-up');
                            } else {
                                icon.classList.remove('fa-chevron-up');
                                icon.classList.add('fa-chevron-down');
                            }
                        }
                    };
                    listContainer.appendChild(itemDiv);
                });
                noDataMessage.style.display = 'none';
            } else {
                noDataMessage.style.display = 'block';
            }
        }


        // --- Funções de Adição Manual ---

        function openSaidaManualModal() {
            document.getElementById('formSaidaManual').reset();
            saidaConjuntoItems = []; // Limpa os itens de conjunto
            saidaAvulsaItems = []; // Limpa os itens avulsos
            updateConjuntoItemsDisplay('saida'); // Atualiza a exibição dos conjuntos
            updateAvulsaItemsDisplay('saida'); // Atualiza a exibição dos avulsos
            
            // Popula os dropdowns de seleção de conjunto para Saída Manual
            populateCJATypesDropdown('saidaConjuntoTipoCJA', CJA_TYPES);
            populateCJAModelsDropdown('saidaConjuntoModeloCJA', CJA_MODELS);
            populateTampoTypesDropdown('saidaConjuntoTampo', TAMPO_TYPES);
            
            openModal('saidaManualModal'); 
        }

        // Função para adicionar um item avulso ao container (reajuste ou saída)
        function addManualItem(typePrefix) {
            // Add a new item to the array, with default values
            const newItem = {
                componente: '',
                quantidade: 1
            };
            let itemsArray;
            if (typePrefix === 'reajuste') {
                itemsArray = reajusteAvulsaItems;
            } else if (typePrefix === 'saida') {
                itemsArray = saidaAvulsaItems;
            } else {
                console.error("Tipo de prefixo inválido para addManualItem:", typePrefix);
                return;
            }
            itemsArray.push(newItem);
            updateAvulsaItemsDisplay(typePrefix); 
        }

        // Função para remover um item avulso do container
        function removeDynamicItem(buttonElement, typePrefix) {
            const itemDiv = buttonElement.closest('div.flex.items-end');
            if (itemDiv) {
                const index = parseInt(itemDiv.getAttribute('data-index'));
                if (isNaN(index)) { 
                    console.error("Invalid data-index for item removal.");
                    return;
                }
                if (typePrefix === 'reajuste') {
                    reajusteAvulsaItems.splice(index, 1);
                } else if (typePrefix === 'saida') {
                    saidaAvulsaItems.splice(index, 1);
                }
                updateAvulsaItemsDisplay(typePrefix); 
            }
        }

        // Função para remover um conjunto pronto do container (apenas para saída manual)
        function removeConjuntoItem(buttonElement) {
            const itemDiv = buttonElement.closest('div.flex.items-center');
            if (itemDiv) {
                const index = parseInt(itemDiv.getAttribute('data-index'));
                if (isNaN(index)) {
                    console.error("Invalid data-index for conjunto item removal.");
                    return;
                }
                saidaConjuntoItems.splice(index, 1);
                updateConjuntoItemsDisplay('saida');
            }
        }

        // Atualiza a exibição dos conjuntos prontos adicionados (para saída manual)
        function updateConjuntoItemsDisplay(type) {
            const container = document.getElementById(`${type}ConjuntoItemsContainer`);
            if (!container) {
                console.error(`Erro: Container de conjunto com ID ${type}ConjuntoItemsContainer não encontrado.`);
                return;
            }
            container.innerHTML = '';
            let hasItems = false;
            const itemsToDisplay = (type === 'saida') ? saidaConjuntoItems : []; // Apenas para saída manual

            if (itemsToDisplay.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum conjunto adicionado ainda.</p>';
                return;
            }

            itemsToDisplay.forEach((item, index) => {
                hasItems = true;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-white p-2 rounded-md shadow-sm mb-2';
                itemDiv.setAttribute('data-index', index); // Adiciona o índice para remoção

                const itemDisplay = `${item.quantidade}x ${item.tipo_cja} ${item.modelo_cja} (Tampo: ${item.tampo_tipo})`;

                itemDiv.innerHTML = `
                    <span class="font-medium">${itemDisplay}</span>
                    <button type="button" onclick="removeConjuntoItem(this)" class="text-red-500 hover:text-red-700 ml-2">&times;</button>
                `;
                container.appendChild(itemDiv);
            });
        }

        // Atualiza a exibição dos itens avulsos adicionados (reajuste ou saída)
        function updateAvulsaItemsDisplay(type) {
            const container = document.getElementById(`${type}ManualItemsContainer`);
            if (!container) {
                console.error(`Erro: Container avulso com ID ${type}ManualItemsContainer não encontrado.`);
                return;
            }
            container.innerHTML = ''; 

            let itemsArray = (type === 'reajuste') ? reajusteAvulsaItems : saidaAvulsaItems;
            
            if (itemsArray.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum item avulso adicionado ainda.</p>';
                return;
            }

            itemsArray.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-end gap-2 mb-2';
                itemDiv.setAttribute('data-index', index); 

                itemDiv.innerHTML = `
                    <div class="flex-1">
                        <label for="${type}AvulsaComponente${index}" class="block text-gray-700 text-sm font-bold mb-1">Componente:</label>
                        <select id="${type}AvulsaComponente${index}" class="select-field w-full">
                            <option value="">Selecione</option>
                            ${ALL_COMPONENTS.map(comp => `<option value="${comp}" ${item.componente === comp ? 'selected' : ''}>${comp}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="${type}AvulsaQuantidade${index}" class="block text-gray-700 text-sm font-bold mb-1">Quantidade:</label>
                        <input type="number" id="${type}AvulsaQuantidade${index}" class="input-field w-full" min="1" value="${item.quantidade}">
                    </div>
                    <button type="button" onclick="removeDynamicItem(this, '${type}')" class="btn-secondary p-2 rounded-md">X</button>
                `;
                container.appendChild(itemDiv);

                const componentSelect = itemDiv.querySelector(`#${type}AvulsaComponente${index}`);
                const quantityInput = itemDiv.querySelector(`#${type}AvulsaQuantidade${index}`);
                componentSelect.addEventListener('change', () => {
                    itemsArray[index].componente = componentSelect.value;
                });
                quantityInput.addEventListener('input', () => {
                    itemsArray[index].quantidade = parseInt(quantityInput.value) || 0;
                });
            });
        }

        function populateCJATypesDropdown(selectId, modelsArray) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) {
                console.error(`Elemento select com ID ${selectId} não encontrado.`);
                return;
            }
            selectElement.innerHTML = '<option value="">Selecione o Tipo</option>'; 
            modelsArray.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                selectElement.appendChild(option);
            });
        }

        function populateCJAModelsDropdown(selectId, modelsArray) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) {
                console.error(`Elemento select com ID ${selectId} não encontrado.`);
                return;
            }
            selectElement.innerHTML = '<option value="">Selecione o Modelo</option>'; 
            modelsArray.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                selectElement.appendChild(option);
            });
        }

        function populateTampoTypesDropdown(selectId, modelsArray) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) {
                console.error(`Elemento select com ID ${selectId} não encontrado.`);
                return;
            }
            selectElement.innerHTML = '<option value="">Selecione o Tampo</option>'; 
            modelsArray.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                selectElement.appendChild(option);
            });
        }

        function populateProducaoMinima(estoqueData) {
            const producaoMinimaTableBody = document.getElementById('producao-minima-table-body');
            const noProducaoMinimaData = document.getElementById('no-producao-minima-data');
            if (!producaoMinimaTableBody) { // Verifica se o tbody existe, não o elemento pai
                console.error('Elemento #producao-minima-table-body não encontrado.');
                return;
            }
            producaoMinimaTableBody.innerHTML = '';
            let hasProducaoMinima = false;
            currentProducaoMinimaData = []; 

            const stockMap = {};
            estoqueData.forEach(item => {
                stockMap[item.modelo] = item.quantidade;
            });

            const cjaModels = CJA_MODELS; 
            const tampoTypes = ['MDF', 'PLASTICO']; // Apenas MDF e PLASTICO para produção mínima

            cjaModels.forEach(model => {
                const rowData = {
                    modelo_cja: model,
                    mdf: 0,
                    plastico: 0
                };

                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                let rowHtml = `<td class="py-3 px-6 text-left">${model}</td>`;

                tampoTypes.forEach(tampoType => {
                    let minProductionForTampoType = 0; 

                    const portaLivroQty = stockMap['PORTA-LIVRO'] || 0;

                    let relevantTampoQty = 0;
                    if (tampoType === 'MDF') {
                        relevantTampoQty = stockMap[`TAMPO-MDF-${model}`] || 0;
                    } else if (tampoType === 'PLASTICO') {
                        // Considera tanto PLASTICO quanto MASTICMOL como "tampão plástico" para produção
                        relevantTampoQty = (stockMap[`TAMPO-PLASTICO-${model}`] || 0) + (stockMap[`TAMPO-MASTICMOL-${model}`] || 0);
                    }

                    // Calcula a produção mínima para cada tipo de CJA (Zurich e Masticmol)
                    // e pega o mínimo entre eles, considerando os componentes comuns e o tampo específico.
                    let minForZurich = Infinity;
                    const assentoZurichQty = stockMap[`ASSENTO-ZURICH-${model}`] || 0;
                    const encostoZurichQty = stockMap[`ENCOSTO-ZURICH-${model}`] || 0;
                    if (assentoZurichQty > 0 && encostoZurichQty > 0 && portaLivroQty > 0 && relevantTampoQty > 0) {
                        minForZurich = Math.min(assentoZurichQty, encostoZurichQty, portaLivroQty, relevantTampoQty);
                    } else {
                        minForZurich = 0; // Se faltar algum componente, não pode produzir
                    }

                    let minForMasticmol = Infinity;
                    const assentoMasticmolQty = stockMap[`ASSENTO-MASTICMOL-${model}`] || 0;
                    const encostoMasticmolQty = stockMap[`ENCOSTO-MASTICMOL-${model}`] || 0;
                    if (assentoMasticmolQty > 0 && encostoMasticmolQty > 0 && portaLivroQty > 0 && relevantTampoQty > 0) {
                        minForMasticmol = Math.min(assentoMasticmolQty, encostoMasticmolQty, portaLivroQty, relevantTampoQty);
                    } else {
                        minForMasticmol = 0; // Se faltar algum componente, não pode produzir
                    }

                    // Se ambos os tipos de CJA podem ser produzidos, pega o maior entre eles
                    // Se apenas um pode, pega o valor desse um. Se nenhum, é 0.
                    minProductionForTampoType = Math.max(minForZurich, minForMasticmol);
                    
                    rowHtml += `<td class="py-3 px-6 text-left">${minProductionForTampoType}</td>`;
                    if (tampoType === 'MDF') {
                        rowData.mdf = minProductionForTampoType;
                    } else if (tampoType === 'PLASTICO') {
                        rowData.plastico = minProductionForTampoType;
                    }
                    if (minProductionForTampoType > 0) {
                        hasProducaoMinima = true;
                    }
                });

                row.innerHTML = rowHtml;
                producaoMinimaTableBody.appendChild(row);
                currentProducaoMinimaData.push(rowData);
            });

            if (noProducaoMinimaData) {
                noProducaoMinimaData.style.display = hasProducaoMinima ? 'none' : 'block';
            }
        }

        function renderMonthlyMovementsChart(movimentacoes) {
            const ctx = document.getElementById('monthlyMovementsChart')?.getContext('2d');
            if (!ctx) {
                console.error("Canvas para o gráfico de movimentações mensais não encontrado.");
                return;
            }

            const monthlyData = {};
            const today = new Date();
            for (let i = 0; i < 6; i++) { 
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthYear = date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
                monthlyData[monthYear] = { entradas: 0, saidas: 0 };
            }

            movimentacoes.forEach(mov => {
                const movDate = new Date(mov.timestamp);
                const monthYear = movDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });

                if (monthlyData[monthYear]) {
                    if (mov.tipo === "Entrada - Manual" && mov.itens) {
                        mov.itens.forEach(item => {
                            if (item.quantidade > 0) { 
                                monthlyData[monthYear].entradas += item.quantidade;
                            }
                        });
                    } else if (mov.tipo === "Saída - Pedido" && mov.itens) {
                        mov.itens.forEach(item => {
                            monthlyData[monthYear].saidas += item.quantidade;
                        });
                    } else if (mov.tipo === "Produção - Conjunto Pronto") {
                        monthlyData[monthYear].entradas += mov.quantidade;
                    }
                }
            });

            const labels = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/');
                const [monthB, yearB] = b.split('/');
                const dateA = new Date(`01 ${monthA} 20${yearA}`);
                const dateB = new Date(`01 ${monthB} 20${yearB}`);
                return dateA - dateB;
            });

            const entradasData = labels.map(label => monthlyData[label].entradas);
            const saidasData = labels.map(label => monthlyData[label].saidas);

            if (monthlyMovementsChartInstance) {
                monthlyMovementsChartInstance.destroy(); 
            }

            monthlyMovementsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: entradasData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3, 
                            fill: true 
                        },
                        {
                            label: 'Saídas',
                            data: saidasData,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3, 
                            fill: true 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        title: {
                            display: true,
                            text: 'Movimentações de Estoque por Mês'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Itens'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mês/Ano'
                            }
                        }
                    }
                }
            });
        }

        // Função para renderizar o gráfico de produção por CJA e Tampo
        async function updateCJAProductionChart(period, triggeredByUser = false) {
            const selectedCJA = document.getElementById('selectCJA').value;
            const selectedTampo = document.getElementById('selectTampo').value;
            const noDataMessage = document.getElementById('no-cja-production-chart-data');
            const chartCanvas = document.getElementById('cjaProductionChart');

            if (triggeredByUser) { 
                document.getElementById('producao-cja-semanal-btn').classList.remove('btn-primary', 'btn-secondary');
                document.getElementById('producao-cja-mensal-btn').classList.remove('btn-primary', 'btn-secondary');

                if (period === 'weekly') {
                    document.getElementById('producao-cja-semanal-btn').classList.add('btn-primary');
                    document.getElementById('producao-cja-mensal-btn').classList.add('btn-secondary');
                } else {
                    document.getElementById('producao-cja-semanal-btn').classList.add('btn-secondary');
                    document.getElementById('producao-cja-mensal-btn').classList.add('btn-primary');
                }
            }


            if (!selectedCJA || !selectedTampo) {
                if (cjaProductionChartInstance) {
                    cjaProductionChartInstance.destroy();
                    cjaProductionChartInstance = null;
                }
                noDataMessage.style.display = 'block';
                return;
            } else {
                noDataMessage.style.display = 'none';
            }

            const productionData = await fetchData(`/production_summary?period=${period}&cja_model=${selectedCJA}&tampo_type=${selectedTampo}`);

            if (!productionData || Object.keys(productionData).length === 0) {
                if (cjaProductionChartInstance) {
                    cjaProductionChartInstance.destroy();
                    cjaProductionChartInstance = null;
                }
                noDataMessage.textContent = 'Nenhum dado de produção encontrado para a seleção.';
                noDataMessage.style.display = 'block';
                return;
            }

            const labels = Object.keys(productionData).sort((a, b) => {
                const year = new Date().getFullYear(); 
                let dateA, dateB;

                if (period === 'weekly') {
                    // Formato "Semana X/YY"
                    const [weekA, yearA] = a.split('/');
                    const [weekB, yearB] = b.split('/');
                    // Aproximação: cria uma data para o meio da semana
                    dateA = new Date(yearA, 0, 1 + (parseInt(weekA) - 1) * 7 + 3);
                    dateB = new Date(yearB, 0, 1 + (parseInt(weekB) - 1) * 7 + 3);
                } else { 
                    // Formato "MMM/AA"
                    const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                    const [monthStrA, yearStrA] = a.split('/');
                    const [monthStrB, yearStrB] = b.split('/');
                    const monthIndexA = monthNames.indexOf(monthStrA);
                    const monthIndexB = monthNames.indexOf(monthStrB);
                    dateA = new Date(`20${yearStrA}`, monthIndexA, 1);
                    dateB = new Date(`20${yearStrB}`, monthIndexB, 1);
                }
                return dateA - dateB;
            });

            const quantities = labels.map(label => productionData[label]);

            if (cjaProductionChartInstance) {
                cjaProductionChartInstance.destroy();
            }

            const ctx = chartCanvas?.getContext('2d');
            if (!ctx) {
                console.error("Canvas para o gráfico de produção CJA não encontrado.");
                return;
            }

            cjaProductionChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Produção de ${selectedCJA} (${selectedTampo})`,
                        data: quantities,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)', 
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Produção de ${selectedCJA} (${selectedTampo}) por ${period === 'weekly' ? 'Semana' : 'Mês'}`
                        },
                        legend: {
                            display: false 
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade Produzida'
                            },
                            ticks: {
                                precision: 0 
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: period === 'weekly' ? 'Semana' : 'Mês/Ano'
                            }
                        }
                    }
                }
            });
        }


        async function loadUsers() { 
            const usersData = await fetchData('/users');
            if (usersData) {
                currentUsersData = usersData; 
                populateUsersTable(usersData);
            }
        }

        function populateUsersTable(data) {
            const tableBody = document.getElementById('table-users').getElementsByTagName('tbody')[0];
            const noUsersData = document.getElementById('no-users-data');
            tableBody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${user.username || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${user.email || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${user.role || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">
                            ${user.username !== currentUser.username ? 
                                `<button onclick="confirmAction('Tem certeza que deseja deletar o usuário \\'${user.username}\\'?', () => deleteUser('${user.username}'))" class="text-red-500 hover:underline">Deletar</button>` 
                                : '<span class="text-gray-400">Você</span>'}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                noUsersData.style.display = 'none';
            } else {
                noUsersData.style.display = 'block';
            }
        }

        async function createUser() { 
            const form = document.getElementById('formCreateUser');
            if (!validateForm('formCreateUser')) {
                showToast('Por favor, corrija os erros no formulário.', 'error');
                return;
            }
            const username = form.elements['newUsername'].value;
            const password = form.elements['newPassword'].value;
            const role = form.elements['newUserRole'].value;

            const data = { username, password, role };
            const result = await postData('/create_user', data);
            if (result) {
                showToast(result.message, 'success');
                form.reset();
                loadUsers(); 
            }
        }

        async function deleteUser(username) { 
            const result = await deleteData(`/delete_user/${username}`);
            if (result) {
                showToast(result.message, 'success');
                loadUsers(); 
            }
        }

        function loadAuditLogs() {
            const filteredLogs = currentMovimentacoesData.map(mov => {
                let detalhes = '';
                let tipoAcao = mov.tipo;

                if (mov.tipo === "Saída - Pedido") {
                    detalhes = `Pedido/OS: ${mov.os_number}, Destino: ${mov.cidade_destino}, Itens: ${mov.itens.map(item => {
                        if (item.modelo_cja && item.tampo_tipo) {
                            return `${item.quantidade}x ${item.tipo_cja || ''} ${item.modelo_cja} (Tampo: ${item.tampo_tipo})`;
                        } else if (item.componente) {
                            return `${item.quantidade}x ${item.componente}`;
                        } else {
                            return 'N/A';
                        }
                    }).join(', ')}`;
                } else if (mov.tipo === "Entrada - Manual") {
                    detalhes = `Tipo: ${mov.tipo_entrada}, Descrição: ${mov.descricao}, Itens: ${mov.itens.map(item => `${item.quantidade}x ${item.componente}`).join(', ')}`;
                } else if (mov.tipo === "Produção - Conjunto Pronto") {
                    detalhes = `Produção: ${mov.quantidade}x ${mov.tipo_cja}-${mov.modelo_cja} (Tampo: ${mov.tampo_tipo}), Destino: ${mov.destino_estoque}`;
                }
                
                return {
                    timestamp: mov.timestamp,
                    registrado_por: mov.registrado_por,
                    tipo: tipoAcao,
                    detalhes: detalhes
                };
            });
            currentAuditLogData = filteredLogs; 
            populateAuditLogsTable(currentAuditLogData);
        }

        function populateAuditLogsTable(data) {
            const tableBody = document.getElementById('table-audit-log').getElementsByTagName('tbody')[0];
            const noDataElement = document.getElementById('no-audit-log-data');
            tableBody.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(log => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${log.timestamp ? new Date(log.timestamp).toLocaleString('pt-BR') : 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${log.registrado_por || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${log.tipo || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${log.detalhes || 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                noDataElement.style.display = 'none';
            } else {
                noDataElement.style.display = 'block';
            }
        }

        // Funções para Pedidos Pendentes (APENAS VISUALIZAÇÃO E ATUALIZAÇÃO DE STATUS)
        async function loadPendingOrders() {
            const pendingOrdersData = await fetchData('/pending_orders');
            if (pendingOrdersData) {
                currentPendingOrdersData = pendingOrdersData;
                populatePendingOrdersTable(pendingOrdersData);
            }
        }

        function populatePendingOrdersTable(data) {
            const tableBody = document.getElementById('table-pending-orders').getElementsByTagName('tbody')[0];
            const noDataElement = document.getElementById('no-pending-orders-data');
            tableBody.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(order => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';

                    const createdDate = order.created_at ? new Date(order.created_at).toLocaleString('pt-BR') : 'N/A';
                    const updatedDate = order.updated_at ? new Date(order.updated_at).toLocaleString('pt-BR') : 'N/A';
                    
                    const itensResumo = order.itens.map(item => {
                        if (item.modelo_cja && item.tampo_tipo) {
                            return `${item.quantidade}x ${item.tipo_cja || ''} ${item.modelo_cja} (Tampo: ${item.tampo_tipo})`;
                        } else if (item.componente) {
                            return `${item.quantidade}x ${item.componente}`;
                        } else {
                            return 'N/A';
                        }
                    }).join(', ');

                    let statusColorClass = '';
                    if (order.status === 'Pendente') {
                        statusColorClass = 'text-yellow-600 font-semibold';
                    } else if (order.status === 'Produzindo') {
                        statusColorClass = 'text-blue-600 font-semibold';
                    } else if (order.status === 'Feito') {
                        statusColorClass = 'text-green-600 font-semibold';
                    }

                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">${order.os_number || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${order.cidade_destino || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${itensResumo}</td>
                        <td class="py-3 px-6 text-left ${statusColorClass}">${order.status || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${createdDate}</td>
                        <td class="py-3 px-6 text-left">${order.created_by || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${updatedDate}</td>
                        <td class="py-3 px-6 text-left">${order.updated_by || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">
                            <select onchange="updatePendingOrderStatus('${order.id}', this.value)" class="select-field text-sm p-1">
                                <option value="">Mudar Status</option>
                                <option value="Pendente" ${order.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="Produzindo" ${order.status === 'Produzindo' ? 'selected' : ''}>Produzindo</option>
                                <option value="Feito" ${order.status === 'Feito' ? 'selected' : ''}>Feito</option>
                            </select>
                            <button onclick="confirmAction('Tem certeza que deseja deletar este pedido pendente?', () => deletePedidoPendente('${order.id}'))" class="bg-red-500 hover:bg-red-700 text-white py-1 px-3 rounded text-xs ml-2"><i class="fas fa-trash"></i> Deletar</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                noDataElement.style.display = 'none';
            } else {
                noDataElement.style.display = 'block';
            }
        }

        async function deletePedidoPendente(id) {
            const result = await deleteData(`/pedidos_pendentes/${id}`);
            if (result) {
                showToast(result.message, 'success');
                loadPendingOrders();
                loadEstoque();
                loadMovimentacoes();
                loadDashboardData();
            }
        }

        async function updatePendingOrderStatus(orderId, newStatus) {
            if (!newStatus) return; 

            confirmAction(`Tem certeza que deseja mudar o status deste pedido para '${newStatus}'?`, async () => {
                const data = { status: newStatus };
                const result = await putData(`/pedidos_pendentes/${orderId}`, data);
                if (result) {
                    showToast(result.message, 'success');
                    loadPendingOrders(); 
                    loadEstoque(); 
                    loadMovimentacoes(); 
                    loadDashboardData(); 
                }
            });
        }

        function confirmAction(message, callback) {
            document.getElementById('confirmModalMessage').textContent = message;
            openModal('customConfirmModal'); // Usa a função openModal
            confirmActionCallback = callback;
        }

        // Função de Paginação Genérica (Não utilizada atualmente, mas mantida para referência futura)
        function renderPagination(containerId, totalPages, currentPage, fetchFunction) {
            const paginationContainer = document.getElementById(containerId);
            paginationContainer.innerHTML = ''; // Limpa a paginação anterior

            if (totalPages <= 1) return; // Não precisa de paginação para 1 ou menos páginas

            const createButton = (text, page, isActive = false) => {
                const button = document.createElement('button');
                button.textContent = text;
                button.classList.add('px-2', 'py-1', 'mx-1', 'rounded-md', 'focus:outline-none', 'text-sm'); /* Tamanho menor */
                if (isActive) {
                    button.classList.add('bg-blue-500', 'text-white');
                } else {
                    button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
                button.addEventListener('click', () => fetchFunction(page));
                return button;
            };

            // Botão "Anterior"
            if (currentPage > 1) {
                paginationContainer.appendChild(createButton('Anterior', currentPage - 1));
            }

            // Números das páginas
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }

            if (startPage > 1) {
                paginationContainer.appendChild(createButton('1', 1));
                if (startPage > 2) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.classList.add('mx-1', 'text-gray-600', 'text-sm');
                    paginationContainer.appendChild(span);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationContainer.appendChild(createButton(i.toString(), i, i === currentPage));
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.classList.add('mx-1', 'text-gray-600', 'text-sm');
                    paginationContainer.appendChild(span);
                }
                paginationContainer.appendChild(createButton(totalPages.toString(), totalPages));
            }

            // Botão "Próximo"
            if (currentPage < totalPages) {
                paginationContainer.appendChild(createButton('Próximo', currentPage + 1));
            }
        }


        // --- Event Listeners e Inicialização (dentro do DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM completamente carregado. Configurando event listeners.");

            // Event listener para o botão de login
            document.getElementById('login-form')?.addEventListener('submit', async function(event) {
                event.preventDefault();
                if (!validateForm('login-form')) {
                    showToast('Por favor, preencha os campos de usuário e senha.', 'error');
                    return;
                }
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                await login(username, password);
            });

            // Event listener para o botão de logout
            document.getElementById('nav-logout')?.addEventListener('click', logout);

            // Event listener para o botão de inicializar dados (apenas para teste)
            document.getElementById('initialize-data-button')?.addEventListener('click', async () => {
                confirmAction('Isso apagará TODOS os dados de estoque, movimentações e usuários e criará os usuários padrão. Tem certeza?', async () => {
                    showLoading();
                    try {
                        const response = await fetch(`${API_BASE_URL}/initialize_data`, { method: 'POST' });
                        const data = await response.json();
                        if (response.ok) {
                            showToast(data.message, 'success');
                            await signOut(auth); 
                        } else {
                            showToast('Erro ao inicializar dados: ' + (data.message || 'Erro desconhecido.'), 'error');
                        }
                    } catch (error) {
                        console.error('Erro ao inicializar dados:', error);
                        showToast('Erro de conexão ao inicializar dados.', 'error');
                    } finally {
                        hideLoading();
                    }
                });
            });

            // Event listener para o toggle da sidebar (mobile)
            document.getElementById('sidebar-toggle-button')?.addEventListener('click', toggleSidebar);

            // Mapeamento dos IDs dos links da sidebar para os IDs das seções no HTML
            const linkToSectionMap = {
                'linkDashboard': 'dashboard-view',
                'linkEstoqueComponentes': 'estoque-componentes-view',
                'linkEstoqueConjuntos': 'estoque-conjuntos-view',
                'linkEstoqueDistrito': 'estoque-distrito-view',
                'linkMovimentacoes': 'movimentacoes-view',
                'linkPedidosPendentes': 'pedidos-pendentes-view',
                'linkLogAuditoria': 'log-auditoria-view',
                'linkGerenciamentoUsuarios': 'gerenciamento-usuarios-view'
            };

            // Event listener para os links da sidebar
            document.querySelectorAll('aside nav ul li a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (link.id === 'linkRegistrarSaidaManual') { // Tratamento especial para o link de Saída Manual
                        openSaidaManualModal();
                    } else {
                        const targetId = linkToSectionMap[link.id]; // Usa o mapeamento
                        if (targetId) {
                            showSection(targetId);
                        } else {
                            console.error(`Mapeamento para o link ID '${link.id}' não encontrado.`);
                        }
                    }
                    
                    // Fecha a sidebar em mobile após clicar no link
                    if (window.innerWidth < 768) {
                        const sidebar = document.getElementById('sidebar');
                        const mainContent = document.getElementById('main-content-wrapper');
                        sidebar.classList.remove('active');
                        sidebar.classList.add('collapsed');
                        mainContent.classList.remove('expanded');
                    }
                });
            });

            // Lidar com o recolhimento/expansão da sidebar ao redimensionar a janela (desktop)
            window.addEventListener('resize', () => {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('main-content-wrapper');
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('active'); // Garante que a classe 'active' do mobile seja removida
                    sidebar.classList.remove('collapsed'); // Estado padrão no desktop
                    mainContent.classList.remove('expanded');
                } else {
                    sidebar.classList.remove('active'); // Começa colapsada no mobile
                    sidebar.classList.add('collapsed');
                    mainContent.classList.remove('expanded');
                }
            });
            // Verificação inicial do estado da sidebar ao carregar
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.add('collapsed');
                }
            }


            // Event listener para o modal de Produção Mínima
            const producaoMinimaModal = document.getElementById('producaoMinimaModal');
            const cardProducaoMinimaModal = document.getElementById('card-producao-minima-modal'); 
            const closeProducaoMinimaModal = document.getElementById('closeProducaoMinimaModal');

            cardProducaoMinimaModal.addEventListener('click', (e) => { 
                e.preventDefault();
                populateProducaoMinima(currentEstoqueData); // Usa os dados reais do estoque
                openModal('producaoMinimaModal');
            });

            closeProducaoMinimaModal.addEventListener('click', () => {
                closeModal('producaoMinimaModal');
            });

            // Fechar modal clicando fora (opcional)
            producaoMinimaModal.addEventListener('click', (e) => {
                if (e.target === producaoMinimaModal) {
                    closeModal('producaoMinimaModal');
                }
            });

            // Event listener para o formulário de Reajuste de Estoque
            document.getElementById('reajusteTipoOperacao')?.addEventListener('change', function() {
                const descricaoContainer = document.getElementById('reajusteDescricaoContainer');
                const descricaoInput = document.getElementById('reajusteDescricao');
                const validationMsg = document.getElementById('reajusteDescricao-validation');

                if (this.value === 'adicionar') {
                    descricaoContainer.classList.remove('hidden');
                    descricaoInput.setAttribute('required', 'true');
                    validateField(descricaoInput, validationMsg); 
                } else {
                    descricaoContainer.classList.add('hidden');
                    descricaoInput.removeAttribute('required');
                    descricaoInput.classList.remove('invalid');
                    validationMsg.classList.remove('show');
                }
            });

            // Popula dropdowns para formulários de adicionar/retirar conjuntos
            populateCJATypesDropdown('addConjuntosTipoCJALocal', CJA_TYPES);
            populateCJAModelsDropdown('addConjuntosModeloCJALocal', CJA_MODELS);
            populateTampoTypesDropdown('addConjuntosTampoTipoLocal', TAMPO_TYPES);

            populateCJATypesDropdown('retirarConjuntosTipoCJALocal', CJA_TYPES);
            populateCJAModelsDropdown('retirarConjuntosModeloCJALocal', CJA_MODELS);
            populateTampoTypesDropdown('retirarConjuntosTampoTipoLocal', TAMPO_TYPES);

            populateCJATypesDropdown('addConjuntosTipoCJADistrito', CJA_TYPES);
            populateCJAModelsDropdown('addConjuntosModeloCJADistrito', CJA_MODELS);
            populateTampoTypesDropdown('addConjuntosTampoTipoDistrito', TAMPO_TYPES);

            populateCJATypesDropdown('retirarConjuntosTipoCJADistrito', CJA_TYPES);
            populateCJAModelsDropdown('retirarConjuntosModeloCJADistrito', CJA_MODELS);
            populateTampoTypesDropdown('retirarConjuntosTampoTipoDistrito', TAMPO_TYPES);

            // Popula dropdowns para o formulário de Saída Manual (conjuntos prontos)
            populateCJATypesDropdown('saidaConjuntoTipoCJA', CJA_TYPES);
            populateCJAModelsDropdown('saidaConjuntoModeloCJA', CJA_MODELS);
            populateTampoTypesDropdown('saidaConjuntoTampo', TAMPO_TYPES);

            // Event listeners para o novo gráfico de produção CJA
            document.getElementById('selectCJA').addEventListener('change', () => updateCJAProductionChart('weekly', true)); 
            document.getElementById('selectTampo').addEventListener('change', () => updateCJAProductionChart('weekly', true)); 

            // Event listeners para os botões de adicionar item avulso (reajuste)
            document.getElementById('add-reajuste-avulsa-item-button').addEventListener('click', () => {
                addManualItem('reajuste');
            });

            // Event listener para o formulário de Reajuste de Estoque
            document.getElementById('formReajusteEstoque')?.addEventListener('submit', async function(event) {
                event.preventDefault();
                if (!validateForm('formReajusteEstoque')) {
                    showToast('Por favor, corrija os erros no formulário.', 'error');
                    return;
                }

                const tipoOperacao = document.getElementById('reajusteTipoOperacao').value;
                const descricao = document.getElementById('reajusteDescricao').value;

                if (reajusteAvulsaItems.length === 0) {
                    showToast('Por favor, adicione pelo menos um item avulso para o reajuste.', 'error');
                    return;
                }

                // Valida os itens avulsos
                let allItemsValid = true;
                reajusteAvulsaItems.forEach((item, index) => {
                    if (!item.componente || item.quantidade <= 0) {
                        allItemsValid = false;
                        showToast(`Item avulso ${index + 1}: Selecione um componente e uma quantidade válida.`, 'error');
                    }
                });

                if (!allItemsValid) {
                    return;
                }

                const data = {
                    tipo_operacao: tipoOperacao,
                    descricao: descricao,
                    itens: reajusteAvulsaItems // Envia os itens avulsos
                };

                const result = await postData('/reajuste_estoque', data);
                if (result) {
                    showToast(result.message, 'success');
                    document.getElementById('formReajusteEstoque').reset();
                    reajusteAvulsaItems = []; // Limpa a lista após o envio
                    updateAvulsaItemsDisplay('reajuste');
                    loadEstoque();
                    loadMovimentacoes();
                    loadDashboardData();
                }
            });


            // Event listener para adicionar conjunto pronto na Saída Manual
            document.getElementById('add-saida-conjunto-button').addEventListener('click', () => {
                const tipoCJA = document.getElementById('saidaConjuntoTipoCJA');
                const modeloCJA = document.getElementById('saidaConjuntoModeloCJA');
                const tampoTipo = document.getElementById('saidaConjuntoTampo');
                const quantidade = document.getElementById('saidaConjuntoQuantidade');

                let isValid = true;
                isValid = validateField(tipoCJA, document.getElementById('saidaConjuntoTipoCJA-validation')) && isValid;
                isValid = validateField(modeloCJA, document.getElementById('saidaConjuntoModeloCJA-validation')) && isValid;
                isValid = validateField(tampoTipo, document.getElementById('saidaConjuntoTampo-validation')) && isValid;
                isValid = validateField(quantidade, document.getElementById('saidaConjuntoQuantidade-validation')) && isValid;

                if (!isValid) {
                    showToast('Por favor, preencha todos os campos obrigatórios para o conjunto.', 'error');
                    return;
                }

                // Adiciona o conjunto pronto como um item
                saidaConjuntoItems.push({
                    tipo_cja: tipoCJA.value,
                    modelo_cja: modeloCJA.value,
                    tampo_tipo: tampoTipo.value,
                    quantidade: parseInt(quantidade.value)
                });

                updateConjuntoItemsDisplay('saida');
                showToast(`Conjunto ${tipoCJA.value}-${modeloCJA.value} (${quantidade.value}x) adicionado para saída.`, 'success');
                // Limpa os campos do formulário de adição de conjunto após adicionar
                tipoCJA.value = '';
                modeloCJA.value = '';
                tampoTipo.value = '';
                quantidade.value = '1';
            });

            // Event listener para adicionar item avulso na Saída Manual
            document.getElementById('add-saida-item-button').addEventListener('click', () => {
                addManualItem('saida');
            });

            // Event listener para o formulário de Saída Manual
            document.getElementById('formSaidaManual')?.addEventListener('submit', async function(event) {
                event.preventDefault();
                if (!validateForm('formSaidaManual')) {
                    showToast('Por favor, corrija os erros no formulário.', 'error');
                    return;
                }

                const osNumber = document.getElementById('saidaOsNumber').value;
                const cidadeDestino = document.getElementById('saidaCidadeDestino').value;
                const dataEmissao = document.getElementById('saidaDataEmissao').value;
                const prazoEntrega = document.getElementById('saidaPrazoEntrega').value;

                // Combina conjuntos prontos e itens avulsos
                const allItems = [];
                saidaConjuntoItems.forEach(item => allItems.push(item));
                saidaAvulsaItems.forEach(item => allItems.push(item));

                if (allItems.length === 0) {
                    showToast('Por favor, adicione pelo menos um conjunto ou item avulso para registrar a saída.', 'error');
                    return;
                }

                // Valida os itens avulsos e conjuntos
                let allItemsValid = true;
                allItems.forEach((item, index) => {
                    // Check for individual components
                    if (item.componente && (!item.componente || item.quantidade <= 0)) {
                        allItemsValid = false;
                        showToast(`Item avulso ${index + 1}: Selecione um componente e uma quantidade válida.`, 'error');
                    } 
                    // Check for complete sets
                    else if (item.modelo_cja && (!item.tipo_cja || !item.modelo_cja || !item.tampo_tipo || item.quantidade <= 0)) {
                        allItemsValid = false;
                        showToast(`Conjunto ${index + 1}: Preencha todos os campos e uma quantidade válida.`, 'error');
                    }
                });

                if (!allItemsValid) {
                    return;
                }

                const data = {
                    os_number: osNumber,
                    cidade_destino: cidadeDestino,
                    data_emissao: dataEmissao,
                    prazo_entrega: prazoEntrega,
                    itens: allItems, // Envia todos os itens combinados
                    tipo: "Saída - Pedido" // Tipo fixo para saída manual
                };

                const result = await postData('/movimentacoes', data);
                if (result) {
                    showToast(result.message, 'success');
                    document.getElementById('formSaidaManual').reset();
                    saidaConjuntoItems = [];
                    saidaAvulsaItems = [];
                    updateConjuntoItemsDisplay('saida');
                    updateAvulsaItemsDisplay('saida');
                    loadEstoque();
                    loadMovimentacoes();
                    loadDashboardData();
                    closeModal('saidaManualModal');
                }
            });

            // Event listeners para os cards do dashboard
            document.getElementById('card-monthly-movements')?.addEventListener('click', () => openDashboardMovementsModal('monthly'));
            document.getElementById('card-weekly-movements')?.addEventListener('click', () => openDashboardMovementsModal('weekly'));
            document.getElementById('card-low-stock')?.addEventListener('click', () => toggleVisibility('low-stock-details-wrapper'));
            document.getElementById('card-producao-minima')?.addEventListener('click', () => toggleVisibility('producao-minima-details-wrapper')); // Este card do dashboard

            // Event listener para fechar o modal de movimentações do dashboard
            document.getElementById('closeDashboardMovementsModal')?.addEventListener('click', () => {
                closeModal('dashboardMovementsModal');
            });

            // Event listeners para as abas de movimentações
            document.getElementById('tab-saidas')?.addEventListener('click', (event) => showMovementType('saidas', event.target));
            document.getElementById('tab-entradas')?.addEventListener('click', (event) => showMovementType('entradas', event.target));
            document.getElementById('tab-producao')?.addEventListener('click', (event) => showMovementType('producao', event.target)); 
        
            // Event listener para o formulário de criação de usuário
            document.getElementById('formCreateUser')?.addEventListener('submit', async function(event) {
                event.preventDefault();
                await createUser();
            });

            // Event listeners para validação de campos
            document.querySelectorAll('input, select, textarea').forEach(input => { 
                input.addEventListener('input', (e) => {
                    const validationMessageElement = document.getElementById(`${e.target.id}-validation`);
                    validateField(e.target, validationMessageElement);
                });
                input.addEventListener('change', (e) => { 
                    const validationMessageElement = document.getElementById(`${e.target.id}-validation`);
                    validateField(e.target, validationMessageElement);
                });
            });

            // Event listeners para campos de pesquisa
            document.getElementById('search-estoque-componentes')?.addEventListener('input', () => {
                filterTable('search-estoque-componentes', currentEstoqueData, populateEstoqueTables);
            });
            document.getElementById('search-conjuntos-prontos-local')?.addEventListener('input', () => {
                filterTable('search-conjuntos-prontos-local', currentEstoqueData, populateEstoqueTables);
            });
            document.getElementById('search-conjuntos-prontos-distrito')?.addEventListener('input', () => {
                filterTable('search-conjuntos-prontos-distrito', currentEstoqueData, populateEstoqueTables);
            });
            document.getElementById('search-movimentacoes')?.addEventListener('input', () => {
                filterTable('search-movimentacoes', currentMovimentacoesData, populateMovimentacoesTable, true);
            });
            document.getElementById('search-audit-log')?.addEventListener('input', () => { 
                filterTable('search-audit-log', currentAuditLogData, populateAuditLogsTable, false, true);
            });
            document.getElementById('search-pending-orders')?.addEventListener('input', () => { 
                filterTable('search-pending-orders', currentPendingOrdersData, populatePendingOrdersTable, false, false, true);
            });
            // New search listener for dashboard movements modal
            document.getElementById('search-dashboard-movements')?.addEventListener('input', () => {
                const listContainer = document.getElementById('dashboard-movements-list');
                const currentData = JSON.parse(listContainer.dataset.currentData || '[]');
                filterTable('search-dashboard-movements', currentData, populateDashboardMovementList, false, false, false, true);
            });


            // Event listeners para ordenação de tabelas
            document.querySelectorAll('#table-zurich th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-zurich', currentEstoqueData.filter(item => item.modelo.includes('ZURICH') && !item.modelo.startsWith('TAMPO-')), populateEstoqueTables, header.dataset.sortKey));
            });
            document.querySelectorAll('#table-masticmol th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-masticmol', currentEstoqueData.filter(item => item.modelo.includes('MASTICMOL') && !item.modelo.startsWith('TAMPO-')), populateEstoqueTables, header.dataset.sortKey));
            });
            document.querySelectorAll('#table-porta-livro th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-porta-livro', currentEstoqueData.filter(item => item.modelo === 'PORTA-LIVRO'), populateEstoqueTables, header.dataset.sortKey));
            });
            document.querySelectorAll('#table-tampos th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-tampos', currentEstoqueData.filter(item => item.modelo.startsWith('TAMPO-')), populateEstoqueTables, header.dataset.sortKey));
            });

            document.querySelectorAll('#table-conjuntos-prontos-local th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-conjuntos-prontos-local', currentEstoqueData.filter(item => item.modelo.startsWith('CONJUNTO-PRONTO-LOCAL-')), populateEstoqueTables, header.dataset.sortKey));
            });
            document.querySelectorAll('#table-conjuntos-prontos-distrito th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-conjuntos-prontos-distrito', currentEstoqueData.filter(item => item.modelo.startsWith('CONJUNTO-PRONTO-DISTRITO-')), populateEstoqueTables, header.dataset.sortKey));
            });
            document.querySelectorAll('#table-producao-minima th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-producao-minima', currentProducaoMinimaData, populateProducaoMinima, header.dataset.sortKey, true));
            });
            document.querySelectorAll('#table-low-stock th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-low-stock', currentLowStockData, populateLowStockTable, header.dataset.sortKey));
            });

            document.querySelectorAll('#table-saidas th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-saidas', currentMovimentacoesData.filter(mov => mov.tipo === "Saída - Pedido"), populateMovimentacoesTable, header.dataset.sortKey));
            });
            document.querySelectorAll('#table-entradas th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-entradas', currentMovimentacoesData.filter(mov => mov.tipo === "Entrada - Manual"), populateMovimentacoesTable, header.dataset.sortKey));
            });
            document.querySelectorAll('#table-producao th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-producao', currentMovimentacoesData.filter(mov => mov.tipo === "Produção - Conjunto Pronto"), populateMovimentacoesTable, header.dataset.sortKey));
            });

            document.querySelectorAll('#table-audit-log th[data-sort-key]').forEach(header => { 
                header.addEventListener('click', () => sortTable('table-audit-log', currentAuditLogData, populateAuditLogsTable, header.dataset.sortKey));
            });

            document.querySelectorAll('#table-users th[data-sort-key]').forEach(header => {
                header.addEventListener('click', () => sortTable('table-users', currentUsersData, populateUsersTable, header.dataset.sortKey));
            });

            document.querySelectorAll('#table-pending-orders th[data-sort-key]').forEach(header => { 
                header.addEventListener('click', () => sortTable('table-pending-orders', currentPendingOrdersData, populatePendingOrdersTable, header.dataset.sortKey));
            });

            // Event listeners para os botões do modal de confirmação
            document.getElementById('confirmModalConfirm').addEventListener('click', () => {
                closeModal('customConfirmModal'); // Usa a função closeModal
                if (confirmActionCallback) {
                    confirmActionCallback();
                    confirmActionCallback = null; 
                }
            });

            document.getElementById('confirmModalCancel').addEventListener('click', () => {
                closeModal('customConfirmModal'); // Usa a função closeModal
                confirmActionCallback = null; 
            });

            // Listener para o estado de autenticação do Firebase
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const idTokenResult = await user.getIdTokenResult();
                    currentUser.token = idTokenResult.token;
                    currentUser.username = user.displayName || user.email.split('@')[0];
                    currentUser.role = idTokenResult.claims.role || 'visualizador';
                    currentUser.firebaseUser = user;

                    showMainContent();
                    updateLoggedInUserDisplay();
                    checkUserRoleAccess();
                    showSection('dashboard-view'); // Garante que a view inicial seja o dashboard
                } else {
                    currentUser.token = null;
                    currentUser.username = null;
                    currentUser.role = null;
                    currentUser.firebaseUser = null;
                    localStorage.removeItem('authToken'); // Limpa qualquer token antigo
                    localStorage.removeItem('username');
                    localStorage.removeItem('role');
                    showLoginScreen();
                }
            });
        });
    </script>
</body>
</html>